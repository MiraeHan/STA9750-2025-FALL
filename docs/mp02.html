<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mirae Han">

<title>The YIMBY Index: Ranking America’s Most Build-Friendly Cities – STA 9750 Submission Material</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-fae2b3aaf5b6259cdc09327568c0539e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">

<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>

<link href="site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">

<script src="site_libs/datatables-binding-0.34.0/datatables.js"></script>

<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>

<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">

<link href="site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">

<script src="site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>

<link href="site_libs/crosstalk-1.2.2/css/crosstalk.min.css" rel="stylesheet">

<script src="site_libs/crosstalk-1.2.2/js/crosstalk.min.js"></script>



</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">STA 9750 Submission Material</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="././home.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-mini-projects" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Mini Projects</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-mini-projects">    
        <li>
    <a class="dropdown-item" href="././mp01.html">
 <span class="dropdown-text">Mini Project 01</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="././mp02.html">
 <span class="dropdown-text">Mini Project 02</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="././mp03.html">
 <span class="dropdown-text">Mini Project 03</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="././mp04.html">
 <span class="dropdown-text">Mini Project 04</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="././finalproject.html">
 <span class="dropdown-text">Final Project!</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="././aboutme.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#task-1-data-import" id="toc-task-1-data-import" class="nav-link active" data-scroll-target="#task-1-data-import"><span class="header-section-number">1</span> Task 1: Data Import</a></li>
  <li><a href="#task-2-multi-table-questions" id="toc-task-2-multi-table-questions" class="nav-link" data-scroll-target="#task-2-multi-table-questions"><span class="header-section-number">2</span> Task 2: Multi-Table Questions</a></li>
  <li><a href="#task-3-initial-visualizations" id="toc-task-3-initial-visualizations" class="nav-link" data-scroll-target="#task-3-initial-visualizations"><span class="header-section-number">3</span> Task 3: Initial Visualizations</a></li>
  <li><a href="#task-4-rent-burden" id="toc-task-4-rent-burden" class="nav-link" data-scroll-target="#task-4-rent-burden"><span class="header-section-number">4</span> Task 4: Rent Burden</a>
  <ul class="collapse">
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"><span class="header-section-number">4.1</span> </a></li>
  </ul></li>
  <li><a href="#task-5-housing-growth" id="toc-task-5-housing-growth" class="nav-link" data-scroll-target="#task-5-housing-growth"><span class="header-section-number">5</span> Task 5: Housing Growth</a>
  <ul class="collapse">
  <li><a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1"><span class="header-section-number">5.1</span> </a></li>
  </ul></li>
  <li><a href="#task-6-visualization" id="toc-task-6-visualization" class="nav-link" data-scroll-target="#task-6-visualization"><span class="header-section-number">6</span> Task 6: Visualization</a></li>
  <li><a href="#task-7-policy-brief" id="toc-task-7-policy-brief" class="nav-link" data-scroll-target="#task-7-policy-brief"><span class="header-section-number">7</span> Task 7: Policy Brief</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">The YIMBY Index: Ranking America’s Most Build-Friendly Cities</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Analyzing Rent Burden &amp; Housing Growth in U.S. Metropolitan Areas</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mirae Han </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Invalid Date</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="task-1-data-import" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Task 1: Data Import</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Tidycensus package to download what we need.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>))){</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>), <span class="at">showWarnings=</span><span class="cn">FALSE</span>, <span class="at">recursive=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>library <span class="ot">&lt;-</span> <span class="cf">function</span>(pkg){</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Mask base::library() to automatically install packages if needed</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Masking is important here so downlit picks up packages and links</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## to documentation</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  pkg <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">substitute</span>(pkg))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">repos =</span> <span class="fu">c</span>(<span class="at">CRAN =</span> <span class="st">"https://cloud.r-project.org"</span>))</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(pkg, <span class="at">character.only=</span><span class="cn">TRUE</span>, <span class="at">quietly=</span><span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(pkg)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">require</span>(pkg, <span class="at">character.only=</span><span class="cn">TRUE</span>, <span class="at">quietly=</span><span class="cn">TRUE</span>))</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>get_acs_all_years <span class="ot">&lt;-</span> <span class="cf">function</span>(variable, <span class="at">geography=</span><span class="st">"cbsa"</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>                              <span class="at">start_year=</span><span class="dv">2009</span>, <span class="at">end_year=</span><span class="dv">2023</span>){</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{variable}_{geography}_{start_year}_{end_year}.csv"</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>, fname)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(fname)){</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    YEARS <span class="ot">&lt;-</span> <span class="fu">seq</span>(start_year, end_year)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    YEARS <span class="ot">&lt;-</span> YEARS[YEARS <span class="sc">!=</span> <span class="dv">2020</span>] <span class="co"># Drop 2020 - No survey (covid)</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    ALL_DATA <span class="ot">&lt;-</span> <span class="fu">map</span>(YEARS, <span class="cf">function</span>(yy){</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>      tidycensus<span class="sc">::</span><span class="fu">get_acs</span>(geography, variable, <span class="at">year=</span>yy, <span class="at">survey=</span><span class="st">"acs1"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">year=</span>yy) <span class="sc">|&gt;</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span>moe, <span class="sc">-</span>variable) <span class="sc">|&gt;</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(<span class="sc">!!</span><span class="at">variable :=</span> estimate)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(ALL_DATA, fname)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(fname, <span class="at">show_col_types=</span><span class="cn">FALSE</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Household income (12 month)</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>INCOME <span class="ot">&lt;-</span> <span class="fu">get_acs_all_years</span>(<span class="st">"B19013_001"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">household_income =</span> B19013_001)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly rent</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>RENT <span class="ot">&lt;-</span> <span class="fu">get_acs_all_years</span>(<span class="st">"B25064_001"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">monthly_rent =</span> B25064_001)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Total population</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>POPULATION <span class="ot">&lt;-</span> <span class="fu">get_acs_all_years</span>(<span class="st">"B01003_001"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">population =</span> B01003_001)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Total number of households</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>HOUSEHOLDS <span class="ot">&lt;-</span> <span class="fu">get_acs_all_years</span>(<span class="st">"B11001_001"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">households =</span> B11001_001)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------------------------------------------</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="do">## Download the number of new housing units built each year</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>get_building_permits <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">start_year =</span> <span class="dv">2009</span>, <span class="at">end_year =</span> <span class="dv">2023</span>){</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"housing_units_{start_year}_{end_year}.csv"</span>)</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>, fname)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(fname)){</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    HISTORICAL_YEARS <span class="ot">&lt;-</span> <span class="fu">seq</span>(start_year, <span class="dv">2018</span>)</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    HISTORICAL_DATA <span class="ot">&lt;-</span> <span class="fu">map</span>(HISTORICAL_YEARS, <span class="cf">function</span>(yy){</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>      historical_url <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"https://www.census.gov/construction/bps/txt/tb3u{yy}.txt"</span>)</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>      LINES <span class="ot">&lt;-</span> <span class="fu">readLines</span>(historical_url)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>)]</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>      CBSA_LINES <span class="ot">&lt;-</span> <span class="fu">str_detect</span>(LINES, <span class="st">"^[[:digit:]]"</span>)</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>      CBSA <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">str_sub</span>(LINES[CBSA_LINES], <span class="dv">5</span>, <span class="dv">10</span>))</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>      PERMIT_LINES <span class="ot">&lt;-</span> <span class="fu">str_detect</span>(<span class="fu">str_sub</span>(LINES, <span class="dv">48</span>, <span class="dv">53</span>), <span class="st">"[[:digit:]]"</span>)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>      PERMITS <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">str_sub</span>(LINES[PERMIT_LINES], <span class="dv">48</span>, <span class="dv">53</span>))</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data_frame</span>(<span class="at">CBSA =</span> CBSA,</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>                 <span class="at">new_housing_units_permitted =</span> PERMITS, </span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>                 <span class="at">year =</span> yy)</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>    CURRENT_YEARS <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">2019</span>, end_year)</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    CURRENT_DATA <span class="ot">&lt;-</span> <span class="fu">map</span>(CURRENT_YEARS, <span class="cf">function</span>(yy){</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>      current_url <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"https://www.census.gov/construction/bps/xls/msaannual_{yy}99.xls"</span>)</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>      temp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>()</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(current_url, <span class="at">destfile =</span> temp, <span class="at">mode=</span><span class="st">"wb"</span>)</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>      fallback <span class="ot">&lt;-</span> <span class="cf">function</span>(.f1, .f2){</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(...){</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>          <span class="fu">tryCatch</span>(<span class="fu">.f1</span>(...), </span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>                   <span class="at">error=</span><span class="cf">function</span>(e) <span class="fu">.f2</span>(...))</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>      reader <span class="ot">&lt;-</span> <span class="fu">fallback</span>(read_xlsx, read_xls)</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>      <span class="fu">reader</span>(temp, <span class="at">skip=</span><span class="dv">5</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>        <span class="fu">na.omit</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(CBSA, Total) <span class="sc">|&gt;</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">year =</span> yy) <span class="sc">|&gt;</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(<span class="at">new_housing_units_permitted =</span> Total)</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>    ALL_DATA <span class="ot">&lt;-</span> <span class="fu">rbind</span>(HISTORICAL_DATA, CURRENT_DATA)</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(ALL_DATA, fname)</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(fname, <span class="at">show_col_types=</span><span class="cn">FALSE</span>)</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>PERMITS <span class="ot">&lt;-</span> <span class="fu">get_building_permits</span>()</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------------------------------------------</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a><span class="do">## Download the latest NAICS data schema</span></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>get_bls_industry_codes <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>, <span class="st">"bls_industry_codes.csv"</span>)</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr)</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidyr)</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(readr)</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(fname)){</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> <span class="fu">request</span>(<span class="st">"https://www.bls.gov"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_url_path</span>(<span class="st">"cew"</span>, <span class="st">"classifications"</span>, <span class="st">"industry"</span>, <span class="st">"industry-titles.htm"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_headers</span>(<span class="st">`</span><span class="at">User-Agent</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:143.0) Gecko/20100101 Firefox/143.0"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_error</span>(<span class="at">is_error =</span> \(resp) <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_perform</span>()</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resp_check_status</span>(resp)</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>    naics_table <span class="ot">&lt;-</span> <span class="fu">resp_body_html</span>(resp) <span class="sc">|&gt;</span></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>      <span class="fu">html_element</span>(<span class="st">"#naics_titles"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>      <span class="fu">html_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">title =</span> <span class="fu">str_trim</span>(<span class="fu">str_remove</span>(<span class="fu">str_remove</span>(<span class="st">`</span><span class="at">Industry Title</span><span class="st">`</span>, Code), <span class="st">"NAICS"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="st">`</span><span class="at">Industry Title</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">depth =</span> <span class="fu">if_else</span>(<span class="fu">nchar</span>(Code) <span class="sc">&lt;=</span> <span class="dv">5</span>, <span class="fu">nchar</span>(Code) <span class="sc">-</span> <span class="dv">1</span>, <span class="cn">NA</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(depth))</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These were looked up manually on bls.gov after finding </span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># they were presented as ranges. Since there are only three</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it was easier to manually handle than to special-case everything else</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>    naics_missing <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span>Code, <span class="sc">~</span>title, <span class="sc">~</span>depth, </span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>      <span class="st">"31"</span>, <span class="st">"Manufacturing"</span>, <span class="dv">1</span>,</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>      <span class="st">"32"</span>, <span class="st">"Manufacturing"</span>, <span class="dv">1</span>,</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>      <span class="st">"33"</span>, <span class="st">"Manufacturing"</span>, <span class="dv">1</span>,</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>      <span class="st">"44"</span>, <span class="st">"Retail"</span>, <span class="dv">1</span>, </span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>      <span class="st">"45"</span>, <span class="st">"Retail"</span>, <span class="dv">1</span>,</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>      <span class="st">"48"</span>, <span class="st">"Transportation and Warehousing"</span>, <span class="dv">1</span>, </span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>      <span class="st">"49"</span>, <span class="st">"Transportation and Warehousing"</span>, <span class="dv">1</span></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>    naics_table <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(naics_table, naics_missing)</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>    naics_table <span class="ot">&lt;-</span> naics_table <span class="sc">|&gt;</span> </span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(depth <span class="sc">==</span> <span class="dv">4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">level4_title=</span>title) <span class="sc">|&gt;</span> </span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">level1_code =</span> <span class="fu">str_sub</span>(Code, <span class="at">end=</span><span class="dv">2</span>), </span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>             <span class="at">level2_code =</span> <span class="fu">str_sub</span>(Code, <span class="at">end=</span><span class="dv">3</span>), </span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>             <span class="at">level3_code =</span> <span class="fu">str_sub</span>(Code, <span class="at">end=</span><span class="dv">4</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(naics_table, <span class="fu">join_by</span>(level1_code <span class="sc">==</span> Code)) <span class="sc">|&gt;</span></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">level1_title=</span>title) <span class="sc">|&gt;</span></span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(naics_table, <span class="fu">join_by</span>(level2_code <span class="sc">==</span> Code)) <span class="sc">|&gt;</span></span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">level2_title=</span>title) <span class="sc">|&gt;</span></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(naics_table, <span class="fu">join_by</span>(level3_code <span class="sc">==</span> Code)) <span class="sc">|&gt;</span></span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">level3_title=</span>title) <span class="sc">|&gt;</span></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">starts_with</span>(<span class="st">"depth"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">level4_code =</span> Code) <span class="sc">|&gt;</span></span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(level1_title, level2_title, level3_title, level4_title, </span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>             level1_code,  level2_code,  level3_code,  level4_code) <span class="sc">|&gt;</span></span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>      <span class="fu">drop_na</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"code"</span>), as.integer))</span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(naics_table, fname)</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(fname, <span class="at">show_col_types=</span><span class="cn">FALSE</span>)</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>INDUSTRY_CODES <span class="ot">&lt;-</span> <span class="fu">get_bls_industry_codes</span>()</span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------------------------------------------</span></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a><span class="do">## Download the BLS Quarterly Census of Employment and Wages</span></span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>get_bls_qcew_annual_averages <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">start_year=</span><span class="dv">2009</span>, <span class="at">end_year=</span><span class="dv">2023</span>){</span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"bls_qcew_{start_year}_{end_year}.csv.gz"</span>)</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>, fname)</span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>  YEARS <span class="ot">&lt;-</span> <span class="fu">seq</span>(start_year, end_year)</span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>  YEARS <span class="ot">&lt;-</span> YEARS[YEARS <span class="sc">!=</span> <span class="dv">2020</span>] <span class="co"># Drop Covid year to match ACS</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(fname)){</span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>    ALL_DATA <span class="ot">&lt;-</span> <span class="fu">map</span>(YEARS, <span class="at">.progress=</span><span class="cn">TRUE</span>, <span class="fu">possibly</span>(<span class="cf">function</span>(yy){</span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>      fname_inner <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>, <span class="fu">glue</span>(<span class="st">"{yy}_qcew_annual_singlefile.zip"</span>))</span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(fname_inner)){</span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>        <span class="fu">request</span>(<span class="st">"https://www.bls.gov"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>          <span class="fu">req_url_path</span>(<span class="st">"cew"</span>, <span class="st">"data"</span>, <span class="st">"files"</span>, yy, <span class="st">"csv"</span>,</span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">glue</span>(<span class="st">"{yy}_annual_singlefile.zip"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>          <span class="fu">req_headers</span>(<span class="st">`</span><span class="at">User-Agent</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:143.0) Gecko/20100101 Firefox/143.0"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>          <span class="fu">req_retry</span>(<span class="at">max_tries=</span><span class="dv">5</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>          <span class="fu">req_perform</span>(fname_inner)</span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">file.info</span>(fname_inner)<span class="sc">$</span>size <span class="sc">&lt;</span> <span class="fl">755e5</span>){</span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="fu">sQuote</span>(fname_inner), <span class="st">"appears corrupted. Please delete and retry this step."</span>)</span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>      <span class="fu">read_csv</span>(fname_inner, </span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>               <span class="at">show_col_types=</span><span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">YEAR =</span> yy) <span class="sc">|&gt;</span></span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(area_fips, </span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>               industry_code, </span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>               annual_avg_emplvl, </span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>               total_annual_wages, </span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>               YEAR) <span class="sc">|&gt;</span></span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="fu">nchar</span>(industry_code) <span class="sc">&lt;=</span> <span class="dv">5</span>, </span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>               <span class="fu">str_starts</span>(area_fips, <span class="st">"C"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="fu">str_detect</span>(industry_code, <span class="st">"-"</span>, <span class="at">negate=</span><span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">FIPS =</span> area_fips, </span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>               <span class="at">INDUSTRY =</span> <span class="fu">as.integer</span>(industry_code), </span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a>               <span class="at">EMPLOYMENT =</span> <span class="fu">as.integer</span>(annual_avg_emplvl), </span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>               <span class="at">TOTAL_WAGES =</span> total_annual_wages) <span class="sc">|&gt;</span></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span>area_fips, </span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>               <span class="sc">-</span>industry_code, </span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>               <span class="sc">-</span>annual_avg_emplvl, </span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>               <span class="sc">-</span>total_annual_wages) <span class="sc">|&gt;</span></span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 10 is a special value: "all industries" , so omit</span></span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(INDUSTRY <span class="sc">!=</span> <span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">AVG_WAGE =</span> TOTAL_WAGES <span class="sc">/</span> EMPLOYMENT)</span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a>    })) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(ALL_DATA, fname)</span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>  ALL_DATA <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fname, <span class="at">show_col_types=</span><span class="cn">FALSE</span>)</span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a>  ALL_DATA_YEARS <span class="ot">&lt;-</span> <span class="fu">unique</span>(ALL_DATA<span class="sc">$</span>YEAR)</span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a>  YEARS_DIFF <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(YEARS, ALL_DATA_YEARS)</span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(YEARS_DIFF) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Download failed for the following years: "</span>, YEARS_DIFF, </span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>         <span class="st">". Please delete intermediate files and try again."</span>)</span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>  ALL_DATA</span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>WAGES <span class="ot">&lt;-</span> <span class="fu">get_bls_qcew_annual_averages</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="task-2-multi-table-questions" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Task 2: Multi-Table Questions</h1>
<ul>
<li><ol type="1">
<li>Which CBSA (by name) permitted the largest number of new housing units in the decade from 2010 to 2019 (inclusive)? The Houston–Sugar Land–Baytown, TX Metropolitan Area (CBSA 26420) permitted the largest number of new housing units during the decade from 2010 to 2019.</li>
</ol></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>top_cbsa <span class="ot">&lt;-</span> PERMITS <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">between</span>(year, <span class="dv">2010</span>, <span class="dv">2019</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(CBSA) <span class="sc">|&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">total_units =</span> <span class="fu">sum</span>(new_housing_units_permitted, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(HOUSEHOLDS, <span class="fu">join_by</span> (<span class="st">"CBSA"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_units)) <span class="sc">|&gt;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>top_cbsa <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">result =</span> <span class="fu">paste</span>(CBSA, NAME)) <span class="sc">|&gt;</span> <span class="fu">pull</span>(result)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "26420 Houston-Sugar Land-Baytown, TX Metro Area"</code></pre>
</div>
</div>
<p>*2. In what year did Albuquerque, NM (CBSA Number 10740) permit the most new housing units? Although 2021 recorded the highest number of new housing permits (4,021 units),this appears to be a COVID-19 data artifact,and the actual peak year is 2017.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>cbsa_names <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(GEOID, NAME) <span class="sc">|&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GEOID =</span> <span class="fu">as.integer</span>(GEOID))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>albuquerque_top_year <span class="ot">&lt;-</span> PERMITS <span class="sc">|&gt;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(CBSA <span class="sc">==</span> <span class="dv">10740</span>, year <span class="sc">!=</span> <span class="dv">2021</span>) <span class="sc">|&gt;</span>  <span class="co"># exclude 2021</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(CBSA, year) <span class="sc">|&gt;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_units =</span> <span class="fu">sum</span>(new_housing_units_permitted, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(cbsa_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"CBSA"</span> <span class="ot">=</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span>  </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_units)) <span class="sc">|&gt;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>albuquerque_top_year</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
   CBSA  year total_units NAME                      
  &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;                     
1 10740  2022        2852 Albuquerque, NM Metro Area</code></pre>
</div>
</div>
<p>*3. Which state (not CBSA) had the highest average individual income in 2015? In 2015, the state with the highest average individual income was the District of Columbia</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>state_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">abb  =</span> <span class="fu">c</span>(state.abb, <span class="st">"DC"</span>, <span class="st">"PR"</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(state.name, <span class="st">"District of Columbia"</span>, <span class="st">"Puerto Rico"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>cbsa_2015 <span class="ot">&lt;-</span> INCOME <span class="sc">|&gt;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(HOUSEHOLDS, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"GEOID"</span>, <span class="st">"NAME"</span>, <span class="st">"year"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(POPULATION, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"GEOID"</span>, <span class="st">"NAME"</span>, <span class="st">"year"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2015</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>cbsa_2015_calc <span class="ot">&lt;-</span> cbsa_2015 <span class="sc">|&gt;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_income_cbsa =</span> household_income <span class="sc">*</span> households,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_extract</span>(NAME, <span class="st">"(?&lt;=, )[A-Z]{2}"</span>)  </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>state_2015 <span class="ot">&lt;-</span> cbsa_2015_calc <span class="sc">|&gt;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state) <span class="sc">|&gt;</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_income =</span> <span class="fu">sum</span>(total_income_cbsa, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_population =</span> <span class="fu">sum</span>(population, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_individual_income =</span> total_income <span class="sc">/</span> total_population) <span class="sc">|&gt;</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(state_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"state"</span> <span class="ot">=</span> <span class="st">"abb"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_individual_income))</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>top_state_2015 <span class="ot">&lt;-</span> state_2015 <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(top_state_2015) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
  state total_income total_population avg_individual_income name                
  &lt;chr&gt;        &lt;dbl&gt;            &lt;dbl&gt;                 &lt;dbl&gt; &lt;chr&gt;               
1 DC    202663489140          6098283                33233. District of Columbia</code></pre>
</div>
</div>
<p>*4. What is the last year in which the NYC CBSA had the most data scientists in the country? The last year New York had the most data scientists in the U.S. was 2015.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>WAGES_CLEAN <span class="ot">&lt;-</span> WAGES <span class="sc">|&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CBSA_join =</span> <span class="fu">as.double</span>(<span class="fu">paste0</span>(<span class="fu">str_remove</span>(FIPS, <span class="st">"^C"</span>), <span class="st">"0"</span>)))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>cbsa_names <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(GEOID, NAME) <span class="sc">|&gt;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GEOID =</span> <span class="fu">as.double</span>(GEOID))</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>data_sci <span class="ot">&lt;-</span> WAGES_CLEAN <span class="sc">|&gt;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(INDUSTRY <span class="sc">==</span> <span class="dv">5182</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR, CBSA_join) <span class="sc">|&gt;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">EMPLOYMENT =</span> <span class="fu">sum</span>(EMPLOYMENT, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>top_cbsa_each_year <span class="ot">&lt;-</span> data_sci <span class="sc">|&gt;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(cbsa_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"CBSA_join"</span> <span class="ot">=</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">|&gt;</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(EMPLOYMENT, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR, NAME, EMPLOYMENT)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>nyc_last_year <span class="ot">&lt;-</span> top_cbsa_each_year <span class="sc">|&gt;</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(NAME, <span class="st">"New York"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">last_year_nyc_led =</span> <span class="fu">max</span>(YEAR, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>top_cbsa_each_year</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 3
    YEAR NAME                                                         EMPLOYMENT
   &lt;dbl&gt; &lt;chr&gt;                                                             &lt;dbl&gt;
 1  2009 New York-Northern New Jersey-Long Island, NY-NJ-PA Metro Ar…      16349
 2  2010 Dallas-Fort Worth-Arlington, TX Metro Area                        13238
 3  2011 Dallas-Fort Worth-Arlington, TX Metro Area                        13283
 4  2012 New York-Northern New Jersey-Long Island, NY-NJ-PA Metro Ar…      14423
 5  2013 New York-Northern New Jersey-Long Island, NY-NJ-PA Metro Ar…      14251
 6  2014 New York-Northern New Jersey-Long Island, NY-NJ-PA Metro Ar…      17828
 7  2015 New York-Northern New Jersey-Long Island, NY-NJ-PA Metro Ar…      18922
 8  2016 San Francisco-Oakland-Fremont, CA Metro Area                      16369
 9  2017 San Francisco-Oakland-Fremont, CA Metro Area                      18089
10  2018 San Francisco-Oakland-Fremont, CA Metro Area                      22379
11  2019 San Francisco-Oakland-Fremont, CA Metro Area                      24154
12  2021 Atlanta-Sandy Springs-Marietta, GA Metro Area                     15810
13  2022 San Francisco-Oakland-Fremont, CA Metro Area                      34080
14  2023 San Francisco-Oakland-Fremont, CA Metro Area                      32961</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nyc_last_year</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  last_year_nyc_led
              &lt;dbl&gt;
1              2015</code></pre>
</div>
</div>
<p>*5. What fraction of total wages in the NYC CBSA was earned by people employed in the finance and insurance industries (NAICS code 52)? In what year did this fraction peak? In the NYC CBSA, the finance and insurance industries made up 16% of total wages, peaking in 2021.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>WAGES_join <span class="ot">&lt;-</span> WAGES <span class="sc">|&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CBSA_join =</span> <span class="fu">as.double</span>(<span class="fu">paste0</span>(<span class="fu">str_remove</span>(FIPS, <span class="st">"C"</span>), <span class="st">"0"</span>)))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>nyc_wages <span class="ot">&lt;-</span> WAGES_join <span class="sc">|&gt;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(CBSA_join <span class="sc">==</span> <span class="dv">35620</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>total_wages <span class="ot">&lt;-</span> nyc_wages <span class="sc">|&gt;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">|&gt;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_wages_all =</span> <span class="fu">sum</span>(TOTAL_WAGES, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>finance_wages <span class="ot">&lt;-</span> nyc_wages <span class="sc">|&gt;</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_starts</span>(<span class="fu">as.character</span>(INDUSTRY), <span class="st">"52"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">|&gt;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_wages_finance =</span> <span class="fu">sum</span>(TOTAL_WAGES, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>nyc_finance_fraction <span class="ot">&lt;-</span> total_wages <span class="sc">|&gt;</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(finance_wages, <span class="at">by =</span> <span class="st">"YEAR"</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fraction =</span> total_wages_finance <span class="sc">/</span> total_wages_all,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> fraction <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(fraction))</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>peak_year <span class="ot">&lt;-</span> nyc_finance_fraction <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>peak_year</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
   YEAR total_wages_all total_wages_finance fraction percent
  &lt;dbl&gt;           &lt;dbl&gt;               &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
1  2021   3636399927489        577101733960    0.159    15.9</code></pre>
</div>
</div>
</section>
<section id="task-3-initial-visualizations" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Task 3: Initial Visualizations</h1>
<p>*1. The relationship between monthly rent and average household income per CBSA in 2009. The scatterplot shows a clear positive relationship between median household income and monthly rent across CBSAs in 2009. In general, areas with higher incomes also have higher rents. Since both axes are on a log scale, the relationship is roughly proportional — when income doubles, rent tends to rise by about 1.5 to 2 times. Most points are close to the trend line, indicating a strong correlation, while a few outliers suggest local differences in housing markets or cost of living.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>rent_income_2009 <span class="ot">&lt;-</span> RENT <span class="sc">|&gt;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2009</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(GEOID, NAME, monthly_rent) <span class="sc">|&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(INCOME <span class="sc">|&gt;</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2009</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(GEOID, household_income),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="st">"GEOID"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(monthly_rent), <span class="sc">!</span><span class="fu">is.na</span>(household_income))</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rent_income_2009, <span class="fu">aes</span>(<span class="at">x =</span> household_income, <span class="at">y =</span> monthly_rent)) <span class="sc">+</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Monthly Rent vs Household Income (CBSA, 2009)"</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Median Household Income"</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Median Monthly Rent"</span>) <span class="sc">+</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mp02_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rent_income_2009, <span class="fu">aes</span>(household_income, monthly_rent)) <span class="sc">+</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">scale_x_log10</span>() <span class="sc">+</span> <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Monthly Rent vs Household Income (Log Scales, 2009)"</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Median Household Income (log)"</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Median Monthly Rent (log)"</span>) <span class="sc">+</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mp02_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>*2. The relationship between total employment and total employment in the health care and social services sector (NAICS 62) across different CBSAs.</p>
<p>I selected the three most populous CBSAs and visualized how employment in the Health Care and Social Assistance sector (NAICS 62) changed over the last five years. The bars show total employment in this sector, and the lines show its share of total employment in each CBSA.</p>
<p>From 2018 to 2023, both New York and Los Angeles saw growth in health and social services employment, with New York consistently leading in size and share. New York’s employment peaked in 2021 at 5.6 million (about 15% of total jobs) before slightly declining and recovering by 2023. Los Angeles also grew steadily from 3.6 to 4.0 million, with its share rising from 11.7% to 12.8%. Both cities hit their highest levels during the pandemic, reflecting increased healthcare demand, and have since stabilized at historically high levels.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>yrs <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(WAGES<span class="sc">$</span>YEAR))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>latest_years <span class="ot">&lt;-</span> <span class="fu">tail</span>(yrs[yrs <span class="sc">!=</span> <span class="dv">2020</span>], <span class="dv">5</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>cbsa_names <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="fu">max</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(GEOID, NAME) <span class="sc">|&gt;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GEOID =</span> <span class="fu">as.integer</span>(GEOID))</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>available_cbsa <span class="ot">&lt;-</span> WAGES <span class="sc">|&gt;</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">%in%</span> latest_years, <span class="fu">str_starts</span>(FIPS, <span class="st">"C"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">CBSA =</span> <span class="fu">as.integer</span>(<span class="fu">paste0</span>(<span class="fu">str_sub</span>(FIPS, <span class="dv">2</span>), <span class="st">"0"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(CBSA)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>top2_cbsa <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> latest_years) <span class="sc">|&gt;</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID, NAME) <span class="sc">|&gt;</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">avg_pop =</span> <span class="fu">mean</span>(population, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GEOID =</span> <span class="fu">as.integer</span>(GEOID)) <span class="sc">|&gt;</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(available_cbsa, <span class="fu">join_by</span>(GEOID <span class="sc">==</span> CBSA)) <span class="sc">|&gt;</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_pop)) <span class="sc">|&gt;</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(GEOID)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>wages_health <span class="ot">&lt;-</span> WAGES <span class="sc">|&gt;</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">%in%</span> latest_years, <span class="fu">str_starts</span>(FIPS, <span class="st">"C"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CBSA =</span> <span class="fu">as.integer</span>(<span class="fu">paste0</span>(<span class="fu">str_sub</span>(FIPS, <span class="dv">2</span>), <span class="st">"0"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(CBSA, YEAR) <span class="sc">|&gt;</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_emp  =</span> <span class="fu">sum</span>(EMPLOYMENT, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">health_emp =</span> <span class="fu">sum</span>(EMPLOYMENT[<span class="fu">str_starts</span>(<span class="fu">as.character</span>(INDUSTRY), <span class="st">"62"</span>)], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">ratio =</span> health_emp <span class="sc">/</span> total_emp,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> wages_health <span class="sc">|&gt;</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(cbsa_names, <span class="fu">join_by</span>(CBSA <span class="sc">==</span> GEOID)) <span class="sc">|&gt;</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(CBSA <span class="sc">%in%</span> top2_cbsa) <span class="sc">|&gt;</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">City =</span> <span class="fu">str_trim</span>(<span class="fu">str_split_fixed</span>(NAME, <span class="st">"–"</span>, <span class="dv">2</span>)[,<span class="dv">1</span>])) <span class="sc">|&gt;</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(City, YEAR, health_emp, ratio) <span class="sc">|&gt;</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(City, YEAR)</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>k  <span class="ot">&lt;-</span> <span class="fu">max</span>(plot_data<span class="sc">$</span>health_emp<span class="sc">/</span><span class="dv">1000</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">max</span>(plot_data<span class="sc">$</span>ratio, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">&lt;-</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.65</span>)</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>bar_width <span class="ot">&lt;-</span> <span class="fl">0.45</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(YEAR))) <span class="sc">+</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> health_emp<span class="sc">/</span><span class="dv">1000</span>, <span class="at">fill =</span> City),</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> bar_width, <span class="at">position =</span> pd, <span class="at">alpha =</span> <span class="fl">0.70</span>) <span class="sc">+</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> health_emp<span class="sc">/</span><span class="dv">1000</span>, <span class="at">label =</span> <span class="fu">comma</span>(health_emp), <span class="at">group =</span> City),</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> pd, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.25</span>, <span class="at">size =</span> <span class="fl">3.1</span>,</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ratio <span class="sc">*</span> k, <span class="at">color =</span> City, <span class="at">group =</span> City),</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> pd, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> ratio <span class="sc">*</span> k, <span class="at">color =</span> City),</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> pd, <span class="at">size =</span> <span class="fl">2.2</span>) <span class="sc">+</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> ratio <span class="sc">*</span> k, <span class="at">label =</span> <span class="fu">percent</span>(ratio, <span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> City, <span class="at">group =</span> City),</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> pd, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.6</span>, <span class="at">size =</span> <span class="fl">3.1</span>,</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Employment in Health/Social (Thousands)"</span>,</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> k, <span class="at">name =</span> <span class="st">"Share of Total Employment (%)"</span>,</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>))</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Health &amp; Social Services Employment — Top 2 CBSAs (by Population)"</span>,</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Employment (bars) &amp; Share (lines), "</span>,</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">min</span>(latest_years), <span class="st">"–"</span>, <span class="fu">max</span>(latest_years)),</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">fill =</span> <span class="st">"City"</span>, <span class="at">color =</span> <span class="st">"City"</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">2000000</span><span class="sc">/</span><span class="dv">1000</span>, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>) <span class="sc">+</span></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mp02_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>*3. The evolution of average household size over time. Use different lines to represent different CBSAs. For a point of extra credit, use the gghighlight package to highlight the NYC and Los Angeles CBSAs in your visualization of household size over time.</p>
<p>The chart shows how average household size changed across U.S. metro areas from 2009 to 2023. Los Angeles (red) consistently had larger households, around 3.1–3.3 people, but has slowly declined since 2016. New York (blue) maintained smaller households, around 2.6–2.8 people, with a slight drop after 2018. Both cities show a gradual decrease, likely reflecting more single-person and smaller families.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gghighlight)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>HH_SIZE <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(GEOID, NAME, year, population) <span class="sc">|&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    HOUSEHOLDS <span class="sc">|&gt;</span> <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(GEOID, year, households),</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">join_by</span>(<span class="st">"GEOID"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>, <span class="st">"year"</span> <span class="sc">==</span> <span class="st">"year"</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">household_size =</span> population <span class="sc">/</span> households) <span class="sc">|&gt;</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>HH_SIZE <span class="ot">&lt;-</span> HH_SIZE <span class="sc">|&gt;</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">City =</span> <span class="fu">case_when</span>(</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(NAME, <span class="st">"^New York"</span>) <span class="sc">~</span> <span class="st">"New York"</span>,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(NAME, <span class="st">"^Los Angeles"</span>) <span class="sc">~</span> <span class="st">"Los Angeles"</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">str_trim</span>(<span class="fu">str_split_fixed</span>(NAME, <span class="st">"–"</span>, <span class="dv">2</span>)[, <span class="dv">1</span>])</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(HH_SIZE, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> household_size, <span class="at">color =</span> City, <span class="at">group =</span> NAME)) <span class="sc">+</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gghighlight</span>(</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    City <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"New York"</span>, <span class="st">"Los Angeles"</span>),</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">unhighlighted_params =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">"#b0c4de"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>),</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">use_direct_label =</span> <span class="cn">TRUE</span>, <span class="at">label_key =</span> City</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"New York"</span> <span class="ot">=</span> <span class="st">"#1f78b4"</span>,    </span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Los Angeles"</span> <span class="ot">=</span> <span class="st">"#e31a1c"</span>) </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">number_format</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Average Household Size Over Time — Highlighting NYC &amp; LA"</span>,</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"ACS 1-year estimates (CBSA 2009–2023)"</span>,</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Household Size (persons per household)"</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"#333333"</span>),</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"#333333"</span>)</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mp02_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="task-4-rent-burden" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Task 4: Rent Burden</h1>
<section id="section" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="section"><span class="header-section-number">4.1</span> </h2>
<p>This code calculates a rent-burden index and shows results in two tables.</p>
<p>It first joins ACS income and rent data by CBSA and year, computing the rent-to-income ratio. The baseline year (first ACS year excluding 2020) is used to standardize values—setting the national average that year to 100. Each CBSA’s rent burden is then expressed relative to that baseline.</p>
<p>For Q1, it displays the yearly rent burden for the New York–Newark–Jersey City metro area in an interactive table with currency and percentage formatting. For Q2, it finds the CBSAs with the highest and lowest rent burden in the most recent year, presenting them side-by-side for quick comparison.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="do">### Join INCOME + RENT and compute rent-to-income</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>rent_burden_raw <span class="ot">&lt;-</span> INCOME <span class="sc">|&gt;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(GEOID, year, household_income) <span class="sc">|&gt;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(RENT <span class="sc">|&gt;</span> <span class="fu">select</span>(GEOID, year, monthly_rent),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="st">"GEOID"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>, <span class="st">"year"</span> <span class="sc">==</span> <span class="st">"year"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rent_to_income =</span> monthly_rent <span class="sc">/</span> (household_income <span class="sc">/</span> <span class="dv">12</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(rent_to_income))</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="do">### Standardization: Baseline = 2009 national average (excluding 2020)</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>baseline_year <span class="ot">&lt;-</span> rent_burden_raw <span class="sc">|&gt;</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">min_year =</span> <span class="fu">min</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(min_year)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>baseline_ratio <span class="ot">&lt;-</span> rent_burden_raw <span class="sc">|&gt;</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> baseline_year) <span class="sc">|&gt;</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">b =</span> <span class="fu">mean</span>(rent_to_income, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(b)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="do">### Scaling: Normalize relative to the baseline year (set baseline = 100)</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>rent_burden_idx <span class="ot">&lt;-</span> rent_burden_raw <span class="sc">|&gt;</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rent_burden_index =</span> <span class="dv">100</span> <span class="sc">*</span> rent_to_income <span class="sc">/</span> baseline_ratio)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="do">### Tables with DT</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="do">## (Q1) Pick a single Metropolitan Area and see how rent burden has changed over time</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="do">## In 2009, the New York–Newark–Jersey City area’s rent burden was about 10% above the national average, showing already high housing costs.</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="do">## By 2023, the index rose to 114.6, about 4% higher than 2009, meaning rent grew slightly faster than income but the burden increase was modest overall.</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>target_cbsa <span class="ot">&lt;-</span> <span class="st">"New York-Newark-Jersey City, NY-NJ-PA Metro Area"</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>table_one <span class="ot">&lt;-</span> rent_burden_idx <span class="sc">|&gt;</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(POPULATION <span class="sc">|&gt;</span> <span class="fu">distinct</span>(GEOID, NAME),</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="st">"GEOID"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(NAME <span class="sc">==</span> target_cbsa) <span class="sc">|&gt;</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, monthly_rent, household_income, rent_to_income, rent_burden_index)</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(table_one, <span class="at">rownames =</span> <span class="cn">FALSE</span>,</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>          <span class="at">caption =</span> htmltools<span class="sc">::</span>tags<span class="sc">$</span><span class="fu">caption</span>(</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">"Rent Burden Over Time — "</span>, target_cbsa,</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>                   <span class="st">" (Baseline Year = "</span>, baseline_year, <span class="st">")"</span>)),</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">20</span>, <span class="at">dom =</span> <span class="st">"tip"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatCurrency</span>(<span class="st">"monthly_rent"</span>, <span class="at">currency =</span> <span class="st">"$"</span>, <span class="at">digits =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatCurrency</span>(<span class="st">"household_income"</span>, <span class="at">currency =</span> <span class="st">"$"</span>, <span class="at">digits =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatPercentage</span>(<span class="st">"rent_to_income"</span>, <span class="at">digits =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(<span class="st">"rent_burden_index"</span>, <span class="at">digits =</span> <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-838e69ab410f066848ae" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-838e69ab410f066848ae">{"x":{"filter":"none","vertical":false,"caption":"<caption>Rent Burden Over Time — New York-Newark-Jersey City, NY-NJ-PA Metro Area (Baseline Year = 2009)<\/caption>","data":[[2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2021,2022,2023],[1125,1150,1187,1209,1237,1281,1308,1346,1379,1434,1482,1600,1685,1764],[62887,61927,62322,63982,65786,67066,68743,71897,75368,78478,83160,84409,91562,95220],[0.2146707586623627,0.2228430248518417,0.2285549244247617,0.2267512737957551,0.2256407138296902,0.2292070497718665,0.228328702558806,0.2246547143830758,0.2195626791211124,0.2192716430082316,0.2138528138528139,0.2274638960300442,0.2208339704244119,0.2223062381852552],[110.6345130601893,114.8462403401646,117.7899725551918,116.8604281201963,116.2880806713154,118.1260573143863,117.6733849671126,115.779927770876,113.1556539983186,113.0056631992358,110.2129701994923,117.2276910598612,113.8108372900468,114.569597485567]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>year<\/th>\n      <th>monthly_rent<\/th>\n      <th>household_income<\/th>\n      <th>rent_to_income<\/th>\n      <th>rent_burden_index<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":20,"dom":"tip","columnDefs":[{"targets":4,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatCurrency(data, \"$\", 0, 3, \",\", \".\", true, null);\n  }"},{"targets":1,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatCurrency(data, \"$\", 0, 3, \",\", \".\", true, null);\n  }"},{"className":"dt-right","targets":[0,1,2,3,4]},{"name":"year","targets":0},{"name":"monthly_rent","targets":1},{"name":"household_income","targets":2},{"name":"rent_to_income","targets":3},{"name":"rent_burden_index","targets":4}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,20,25,50,100]}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render"],"jsHooks":[]}</script>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## (Q2) Highlight the Metro Areas highest and lowest with the highest and lowest rent burden</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>latest_year <span class="ot">&lt;-</span> rent_burden_idx <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">latest =</span> <span class="fu">max</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(latest)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>hi_lo <span class="ot">&lt;-</span> rent_burden_idx <span class="sc">|&gt;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> latest_year) <span class="sc">|&gt;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(POPULATION <span class="sc">|&gt;</span> <span class="fu">distinct</span>(GEOID, NAME),</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="st">"GEOID"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(NAME, year, rent_to_income, rent_burden_index)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>highest_row <span class="ot">&lt;-</span> hi_lo <span class="sc">|&gt;</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(rent_burden_index), <span class="fu">desc</span>(rent_to_income), NAME) <span class="sc">|&gt;</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"Highest"</span>)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>lowest_row <span class="ot">&lt;-</span> hi_lo <span class="sc">|&gt;</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(rent_burden_index, rent_to_income, NAME) <span class="sc">|&gt;</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"Lowest"</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>table_two <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(highest_row, lowest_row) <span class="sc">|&gt;</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="fu">factor</span>(Group, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Highest"</span>, <span class="st">"Lowest"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Group)</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  table_two, </span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">rownames =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> htmltools<span class="sc">::</span>tags<span class="sc">$</span><span class="fu">caption</span>(</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="st">'caption-side: top; text-align: left; font-weight: bold; font-size: 16px;'</span>,</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"Highest &amp; Lowest Metro Areas by Rent Burden — "</span>, latest_year)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">2</span>, <span class="at">dom =</span> <span class="st">"t"</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatPercentage</span>(<span class="st">"rent_to_income"</span>, <span class="at">digits =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(<span class="st">"rent_burden_index"</span>, <span class="at">digits =</span> <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-6bb15d8a441fddc67ea2" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-6bb15d8a441fddc67ea2">{"x":{"filter":"none","vertical":false,"caption":"<caption style=\"caption-side: top; text-align: left; font-weight: bold; font-size: 16px;\">Highest &amp; Lowest Metro Areas by Rent Burden — 2023<\/caption>","data":[["Clearlake, CA Micro Area","Laconia, NH Micro Area"],[2023,2023],[0.3116883116883117,0.1273799287556811],[160.6342885498673,65.64758274177187],["Highest","Lowest"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>NAME<\/th>\n      <th>year<\/th>\n      <th>rent_to_income<\/th>\n      <th>rent_burden_index<\/th>\n      <th>Group<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":2,"dom":"t","columnDefs":[{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 1, 3, \",\", \".\", null);\n  }"},{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatPercentage(data, 1, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[1,2,3]},{"name":"NAME","targets":0},{"name":"year","targets":1},{"name":"rent_to_income","targets":2},{"name":"rent_burden_index","targets":3},{"name":"Group","targets":4}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[2,10,25,50,100]}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render"],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="task-5-housing-growth" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Task 5: Housing Growth</h1>
<section id="section-1" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="section-1"><span class="header-section-number">5.1</span> </h2>
<p>This code measures housing growth across CBSAs and identifies which cities are more “building-friendly.”</p>
<p>It joins population and building permit data, calculates 5-year population growth, and removes missing or zero values. Two indicators are then computed:</p>
<p>Instant growth: permits per person.</p>
<p>Rate growth: permits per 5-year population change.</p>
<p>Both are standardized (z-scores) and summed into a composite score, where higher values mean faster housing expansion. Finally, it lists the top 10 and bottom 10 CBSAs for the most recent year in an interactive table.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RcppRoll)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Join POPULATION and PERMITS tables</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>housing_raw <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GEOID =</span> <span class="fu">as.integer</span>(GEOID)) <span class="sc">|&gt;</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(GEOID, NAME, year, population) <span class="sc">|&gt;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    PERMITS <span class="sc">|&gt;</span> <span class="fu">select</span>(CBSA, year, new_housing_units_permitted),</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">join_by</span>(GEOID <span class="sc">==</span> CBSA, year <span class="sc">==</span> year)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">permits =</span> new_housing_units_permitted) <span class="sc">|&gt;</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(GEOID, year)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Compute 5-year population growth</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>housing_raw <span class="ot">&lt;-</span> housing_raw <span class="sc">|&gt;</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID) <span class="sc">|&gt;</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pop_growth_5yr =</span> population <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(population, <span class="dv">5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Apply a 5-year rolling average to smooth noisy data</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>housing_smoothed <span class="ot">&lt;-</span> housing_raw <span class="sc">|&gt;</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID) <span class="sc">|&gt;</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">permits_5yr_avg    =</span> RcppRoll<span class="sc">::</span><span class="fu">roll_meanr</span>(permits,    <span class="at">n =</span> <span class="dv">5</span>, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">population_5yr_avg =</span> RcppRoll<span class="sc">::</span><span class="fu">roll_meanr</span>(population, <span class="at">n =</span> <span class="dv">5</span>, <span class="at">fill =</span> <span class="cn">NA</span>)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="do">## Remove invalid observations (NA or zero values)</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>housing_growth <span class="ot">&lt;-</span> housing_smoothed <span class="sc">|&gt;</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(pop_growth_5yr), pop_growth_5yr <span class="sc">!=</span> <span class="dv">0</span>,</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(permits), permits <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(population), population <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="do">## Instantaneous metric: permits per person </span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="do">## Rate-based metric: permits per 5-year population change</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a><span class="do">## (negative values indicate construction slower than population loss) </span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">instant_growth =</span> permits <span class="sc">/</span> population,</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">rate_growth =</span> permits <span class="sc">/</span> pop_growth_5yr</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a><span class="do">## Standardize metrics (Z-scores) and create a composite index</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a><span class="do">## Z-scores normalize each metric (mean = 0, sd = 1)</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="do">## Composite score C = Z_instant + Z_rate</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a><span class="do">## &gt;0 means "Building-Friendly", &lt;0 means "Not Friendly"</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>housing_growth <span class="ot">&lt;-</span> housing_growth <span class="sc">|&gt;</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">z_instant =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(instant_growth)),</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">z_rate    =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(rate_growth)),</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">composite_score =</span> z_instant <span class="sc">+</span> z_rate,</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">friendly_flag   =</span> <span class="fu">if_else</span>(composite_score <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Building-Friendly"</span>, <span class="st">"Not Friendly"</span>)</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a><span class="do">## Identify top and bottom CBSAs for the most recent year</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>latest_year <span class="ot">&lt;-</span> housing_growth <span class="sc">|&gt;</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">max</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>()</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>table_latest <span class="ot">&lt;-</span> housing_growth <span class="sc">|&gt;</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> latest_year) <span class="sc">|&gt;</span></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(NAME, year, instant_growth, rate_growth, composite_score, friendly_flag) <span class="sc">|&gt;</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(composite_score))</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a><span class="do">## Create summary tables (Top 10 / Bottom 10)</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>table_top_bottom <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>  table_latest <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"Highest"</span>),</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>  table_latest <span class="sc">|&gt;</span> <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"Lowest"</span>)</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Group), <span class="fu">desc</span>(composite_score))</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a><span class="do">## Display interactive table (DT)</span></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>  table_top_bottom,</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">rownames =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> htmltools<span class="sc">::</span>tags<span class="sc">$</span><span class="fu">caption</span>(</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="st">'caption-side: top; text-align: left; font-weight: bold; font-size: 16px;'</span>,</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"Top &amp; Bottom CBSAs by Building-Friendliness — "</span>, latest_year,</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>           <span class="st">" (Zeros/NA excluded)"</span>)</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">20</span>, <span class="at">dom =</span> <span class="st">"tip"</span>)</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(<span class="fu">c</span>(<span class="st">"instant_growth"</span>, <span class="st">"rate_growth"</span>, <span class="st">"composite_score"</span>), <span class="at">digits =</span> <span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-7291cfba0430aca4ceab" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-7291cfba0430aca4ceab">{"x":{"filter":"none","vertical":false,"caption":"<caption style=\"caption-side: top; text-align: left; font-weight: bold; font-size: 16px;\">Top &amp; Bottom CBSAs by Building-Friendliness — 2023 (Zeros/NA excluded)<\/caption>","data":[["Enid, OK Metro Area","Weirton-Steubenville, WV-OH Metro Area","Morgantown, WV Metro Area","Victoria, TX Metro Area","Danville, IL Micro Area","Wheeling, WV-OH Metro Area","Lawrence, KS Metro Area","Vineland, NJ Metro Area","Canton-Massillon, OH Metro Area","Sierra Vista-Douglas, AZ Metro Area","Salisbury, MD Metro Area","Myrtle Beach-Conway-North Myrtle Beach, SC Metro Area","Punta Gorda, FL Metro Area","Crestview-Fort Walton Beach-Destin, FL Metro Area","North Port-Bradenton-Sarasota, FL Metro Area","Daphne-Fairhope-Foley, AL Metro Area","Sherman-Denison, TX Metro Area","Cape Coral-Fort Myers, FL Metro Area","Austin-Round Rock-San Marcos, TX Metro Area","Burlington, NC Metro Area"],[2023,2023,2023,2023,2023,2023,2023,2023,2023,2023,2023,2023,2023,2023,2023,2023,2023,2023,2023,2023],[0.0001612305112619512,0.0001402204967311097,0.0001198727938117433,0.0009001620291652498,0.0001116507564338748,8.117062803928659e-05,0.001849808797790184,0.0006761813478985859,0.001281685416322464,0.003899229781771502,0.03773032148639272,0.03314900447320355,0.02148602365451599,0.01835849588935037,0.01750121963547183,0.01721057012232404,0.01665679647668253,0.01624303685836949,0.01567678482983089,0.015237351045126],[0.02262443438914027,-0.002878733357322778,0.00546975546975547,-0.3658536585365854,-0.001278568003835704,-0.00191737842077741,-0.9291666666666667,-0.4858490566037736,-1.130242825607064,-4.189655172413793,-0.01772270164371358,-0.1975797381798551,0.1837683083689473,0.1671845124282983,0.1510937411068319,0.1067296166735977,0.1551975645335194,0.1421724401933948,0.1084717217609275,0.1627518779062835],[-1.232160828021,-1.253577200597443,-1.254340488764193,-1.256007789668521,-1.260767708528532,-1.269857214219091,-1.32537787950323,-1.39250299354986,-1.609154860617533,-2.711210751777188,9.470972209898408,8.054090429724191,4.954360902553852,4.051297625817576,3.796782752294186,3.686971386057547,3.558145981851401,3.432126626136442,3.250065615312145,3.157402543119558],["Not Friendly","Not Friendly","Not Friendly","Not Friendly","Not Friendly","Not Friendly","Not Friendly","Not Friendly","Not Friendly","Not Friendly","Building-Friendly","Building-Friendly","Building-Friendly","Building-Friendly","Building-Friendly","Building-Friendly","Building-Friendly","Building-Friendly","Building-Friendly","Building-Friendly"],["Lowest","Lowest","Lowest","Lowest","Lowest","Lowest","Lowest","Lowest","Lowest","Lowest","Highest","Highest","Highest","Highest","Highest","Highest","Highest","Highest","Highest","Highest"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>NAME<\/th>\n      <th>year<\/th>\n      <th>instant_growth<\/th>\n      <th>rate_growth<\/th>\n      <th>composite_score<\/th>\n      <th>friendly_flag<\/th>\n      <th>Group<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":20,"dom":"tip","columnDefs":[{"targets":2,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 3, 3, \",\", \".\", null);\n  }"},{"targets":3,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 3, 3, \",\", \".\", null);\n  }"},{"targets":4,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 3, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[1,2,3,4]},{"name":"NAME","targets":0},{"name":"year","targets":1},{"name":"instant_growth","targets":2},{"name":"rate_growth","targets":3},{"name":"composite_score","targets":4},{"name":"friendly_flag","targets":5},{"name":"Group","targets":6}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,20,25,50,100]}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render"],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="task-6-visualization" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Task 6: Visualization</h1>
<p>This code visualizes how housing growth and rent burden interact across U.S. metro areas.</p>
<p>The first plot compares each CBSA’s change in rent burden (x-axis) and average housing growth (y-axis), with bubble size showing population growth. Cities in the upper-left quadrant built housing fast enough to reduce rent burden—potential “YIMBY success stories.”</p>
<p>The second plot aggregates these results by state, ranking the Top 10 YIMBY-oriented states using a composite score that combines rent burden reduction, housing growth, and population growth.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Visualization 1 -----------------------------------------</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="do">## The plot shows that CBSAs in the upper-left region—particularly several smaller metros like Salisbury and Hammond—</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="do">## built housing rapidly enough that rent burdens fell despite population growth, illustrating potential “YIMBY success stories.”</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Tables</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Define early and late periods</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>early_years <span class="ot">&lt;-</span> <span class="dv">2009</span><span class="sc">:</span><span class="dv">2012</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>late_years  <span class="ot">&lt;-</span> <span class="dv">2021</span><span class="sc">:</span><span class="dv">2023</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract unique CBSA names</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>cbsa_names <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span> <span class="fu">distinct</span>(GEOID, NAME)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Rent Burden Summary</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>rb_summary <span class="ot">&lt;-</span> rent_burden_idx <span class="sc">|&gt;</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID) <span class="sc">|&gt;</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">rb_early =</span> <span class="fu">mean</span>(rent_burden_index[year <span class="sc">%in%</span> early_years], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">rb_late  =</span> <span class="fu">mean</span>(rent_burden_index[year <span class="sc">%in%</span> late_years],  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">rb_delta =</span> rb_late <span class="sc">-</span> rb_early</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(rb_early), <span class="fu">is.finite</span>(rb_late), <span class="fu">is.finite</span>(rb_delta))</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="do">## Population Summary</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>pop_summary <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID) <span class="sc">|&gt;</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_first_year =</span> <span class="fu">min</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_last_year  =</span> <span class="fu">max</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_start =</span> <span class="fu">first</span>(population[year <span class="sc">==</span> pop_first_year]),</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_end   =</span> <span class="fu">first</span>(population[year <span class="sc">==</span> pop_last_year]),</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_change_abs =</span> pop_end <span class="sc">-</span> pop_start,</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_change_pct =</span> <span class="fu">ifelse</span>(pop_start <span class="sc">&gt;</span> <span class="dv">0</span>, (pop_end <span class="sc">-</span> pop_start)<span class="sc">/</span>pop_start, <span class="cn">NA_real_</span>)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a><span class="do">## Housing Growth Summary</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>hg_summary <span class="ot">&lt;-</span> housing_growth <span class="sc">|&gt;</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;=</span> <span class="dv">2014</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID) <span class="sc">|&gt;</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">hg_avg =</span> <span class="fu">mean</span>(composite_score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(hg_avg))</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a><span class="do">## Combine and Clean Up</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>summary_cbsa <span class="ot">&lt;-</span> rb_summary <span class="sc">|&gt;</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(pop_summary, <span class="at">by =</span> <span class="st">"GEOID"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(hg_summary,  <span class="at">by =</span> <span class="st">"GEOID"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(cbsa_names,  <span class="at">by =</span> <span class="st">"GEOID"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(rb_delta), <span class="fu">is.finite</span>(hg_avg)) <span class="sc">|&gt;</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flag CBSAs with early rent burden in top 25%</span></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">early_high_flag =</span> rb_early <span class="sc">&gt;=</span> <span class="fu">quantile</span>(rb_early, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean population growth percentage (non-negative)</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">size_var =</span> <span class="fu">pmax</span>(<span class="dv">0</span>, pop_change_pct),</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">size_var =</span> <span class="fu">replace_na</span>(size_var, <span class="dv">0</span>)</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(size_var))</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a><span class="do">## National mean of housing growth (for reference line)</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>hg_mean_all <span class="ot">&lt;-</span> <span class="fu">mean</span>(summary_cbsa<span class="sc">$</span>hg_avg, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot with Safety Checks</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> summary_cbsa <span class="sc">|&gt;</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rb_delta, <span class="at">y =</span> hg_avg)) <span class="sc">+</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reference lines</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> hg_mean_all, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scatter points</span></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">size =</span> size_var, <span class="at">color =</span> early_high_flag),</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>,</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Color and size scales</span></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"#d62728"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"#8da0cb"</span>),</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"High Early Rent Burden"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"Others"</span>),</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">name   =</span> <span class="st">"Early Rent Burden"</span></span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">range =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="dv">9</span>),</span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(summary_cbsa<span class="sc">$</span>size_var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>),</span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Population Growth (%)"</span></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Titles and labels</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"YIMBY Quadrant — Rent Burden Change vs Housing Growth"</span>,</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Left = Rent burden ↓ ; Up = Housing growth ↑ ; Size = Population growth"</span>,</span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Change in Rent Burden Index (Late − Early) → lower is better"</span>,</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Housing Growth (Composite Score)"</span></span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>)</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>p1</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mp02_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Add Labels (Optional, without ggrepel)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>yimby_candidates <span class="ot">&lt;-</span> summary_cbsa <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(early_high_flag, rb_delta <span class="sc">&lt;</span> <span class="dv">0</span>, pop_change_abs <span class="sc">&gt;</span> <span class="dv">0</span>, hg_avg <span class="sc">&gt;</span> hg_mean_all)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>top_labels <span class="ot">&lt;-</span> yimby_candidates <span class="sc">|&gt;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(rb_delta, <span class="fu">desc</span>(hg_avg), <span class="fu">desc</span>(pop_change_abs)) <span class="sc">|&gt;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>p1_labels <span class="ot">&lt;-</span> p1 <span class="sc">+</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> top_labels,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_remove</span>(NAME, <span class="st">" Metro Area$"</span>)),</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">check_overlap =</span> <span class="cn">TRUE</span>,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="sc">-</span><span class="fl">0.02</span>, <span class="at">y =</span> <span class="fl">0.02</span>),</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.2</span>,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">fontface =</span> <span class="st">"bold"</span>,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>p1_labels</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mp02_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Visualization 2 -------------------------------------------------------------</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Top 10 YIMBY-Oriented States</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Compute YIMBY composite score by CBSA</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>yimby_score <span class="ot">&lt;-</span> summary_cbsa <span class="sc">|&gt;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">yimby_score =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(<span class="sc">-</span>rb_delta) <span class="sc">+</span> <span class="fu">scale</span>(hg_avg) <span class="sc">+</span> <span class="fu">scale</span>(size_var))</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract state abbreviation from NAME (e.g., ", FL" → "FL")</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>yimby_score <span class="ot">&lt;-</span> yimby_score <span class="sc">|&gt;</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_extract</span>(NAME, <span class="st">"(?&lt;=, )[A-Z]{2}"</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(state))</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Aggregate to state-level (mean score across CBSAs)</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>state_yimby <span class="ot">&lt;-</span> yimby_score <span class="sc">|&gt;</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state) <span class="sc">|&gt;</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_yimby_score =</span> <span class="fu">mean</span>(yimby_score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_burden_share =</span> <span class="fu">mean</span>(early_high_flag, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># share of high-burden CBSAs</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_yimby_score)) <span class="sc">|&gt;</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)  <span class="co"># 🔹 Top 10 States</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(state_yimby, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(state, avg_yimby_score),</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>                        <span class="at">y =</span> avg_yimby_score,</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>                        <span class="at">fill =</span> high_burden_share)) <span class="sc">+</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">alpha =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">"#377eb8"</span>, <span class="at">high =</span> <span class="st">"#e31a1c"</span>,</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Share of High Early Rent Burden CBSAs"</span>,</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Top 10 YIMBY-Oriented States"</span>,</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Average Composite Score = (-ΔRent Burden) + Housing Growth + Population Growth"</span>,</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"State"</span>,</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average YIMBY Composite Score (standardized)"</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>) <span class="sc">+</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mp02_files/figure-html/unnamed-chunk-12-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="task-7-policy-brief" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Task 7: Policy Brief</h1>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/MiraeHan\.github\.io\/STA9750-2025-FALL\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "The YIMBY Index: Ranking America’s Most Build-Friendly Cities"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Analyzing Rent Burden &amp; Housing Growth in U.S. Metropolitan Areas"</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Mirae Han</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "`r format(Sys.time(), '%B %d, %Y')`"</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html: </span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: right</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: true</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="an">csl:</span><span class="co"> apa.csl</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="fu"># Task 1: Data Import</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="do">## Tidycensus package to download what we need.</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>))){</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>), <span class="at">showWarnings=</span><span class="cn">FALSE</span>, <span class="at">recursive=</span><span class="cn">TRUE</span>)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>library <span class="ot">&lt;-</span> <span class="cf">function</span>(pkg){</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Mask base::library() to automatically install packages if needed</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Masking is important here so downlit picks up packages and links</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  <span class="do">## to documentation</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  pkg <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">substitute</span>(pkg))</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">repos =</span> <span class="fu">c</span>(<span class="at">CRAN =</span> <span class="st">"https://cloud.r-project.org"</span>))</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(pkg, <span class="at">character.only=</span><span class="cn">TRUE</span>, <span class="at">quietly=</span><span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(pkg)</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">require</span>(pkg, <span class="at">character.only=</span><span class="cn">TRUE</span>, <span class="at">quietly=</span><span class="cn">TRUE</span>))</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>get_acs_all_years <span class="ot">&lt;-</span> <span class="cf">function</span>(variable, <span class="at">geography=</span><span class="st">"cbsa"</span>,</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>                              <span class="at">start_year=</span><span class="dv">2009</span>, <span class="at">end_year=</span><span class="dv">2023</span>){</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{variable}_{geography}_{start_year}_{end_year}.csv"</span>)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>, fname)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(fname)){</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>    YEARS <span class="ot">&lt;-</span> <span class="fu">seq</span>(start_year, end_year)</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    YEARS <span class="ot">&lt;-</span> YEARS[YEARS <span class="sc">!=</span> <span class="dv">2020</span>] <span class="co"># Drop 2020 - No survey (covid)</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    ALL_DATA <span class="ot">&lt;-</span> <span class="fu">map</span>(YEARS, <span class="cf">function</span>(yy){</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>      tidycensus<span class="sc">::</span><span class="fu">get_acs</span>(geography, variable, <span class="at">year=</span>yy, <span class="at">survey=</span><span class="st">"acs1"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">year=</span>yy) <span class="sc">|&gt;</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span>moe, <span class="sc">-</span>variable) <span class="sc">|&gt;</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(<span class="sc">!!</span><span class="at">variable :=</span> estimate)</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(ALL_DATA, fname)</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(fname, <span class="at">show_col_types=</span><span class="cn">FALSE</span>)</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Household income (12 month)</span></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>INCOME <span class="ot">&lt;-</span> <span class="fu">get_acs_all_years</span>(<span class="st">"B19013_001"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">household_income =</span> B19013_001)</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly rent</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>RENT <span class="ot">&lt;-</span> <span class="fu">get_acs_all_years</span>(<span class="st">"B25064_001"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">monthly_rent =</span> B25064_001)</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Total population</span></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>POPULATION <span class="ot">&lt;-</span> <span class="fu">get_acs_all_years</span>(<span class="st">"B01003_001"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">population =</span> B01003_001)</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Total number of households</span></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>HOUSEHOLDS <span class="ot">&lt;-</span> <span class="fu">get_acs_all_years</span>(<span class="st">"B11001_001"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">households =</span> B11001_001)</span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------------------------------------------</span></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a><span class="do">## Download the number of new housing units built each year</span></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>get_building_permits <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">start_year =</span> <span class="dv">2009</span>, <span class="at">end_year =</span> <span class="dv">2023</span>){</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"housing_units_{start_year}_{end_year}.csv"</span>)</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>, fname)</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(fname)){</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>    HISTORICAL_YEARS <span class="ot">&lt;-</span> <span class="fu">seq</span>(start_year, <span class="dv">2018</span>)</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>    HISTORICAL_DATA <span class="ot">&lt;-</span> <span class="fu">map</span>(HISTORICAL_YEARS, <span class="cf">function</span>(yy){</span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>      historical_url <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"https://www.census.gov/construction/bps/txt/tb3u{yy}.txt"</span>)</span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>      LINES <span class="ot">&lt;-</span> <span class="fu">readLines</span>(historical_url)[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>)]</span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>      CBSA_LINES <span class="ot">&lt;-</span> <span class="fu">str_detect</span>(LINES, <span class="st">"^[[:digit:]]"</span>)</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>      CBSA <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">str_sub</span>(LINES[CBSA_LINES], <span class="dv">5</span>, <span class="dv">10</span>))</span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>      PERMIT_LINES <span class="ot">&lt;-</span> <span class="fu">str_detect</span>(<span class="fu">str_sub</span>(LINES, <span class="dv">48</span>, <span class="dv">53</span>), <span class="st">"[[:digit:]]"</span>)</span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>      PERMITS <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">str_sub</span>(LINES[PERMIT_LINES], <span class="dv">48</span>, <span class="dv">53</span>))</span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data_frame</span>(<span class="at">CBSA =</span> CBSA,</span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>                 <span class="at">new_housing_units_permitted =</span> PERMITS, </span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>                 <span class="at">year =</span> yy)</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>    CURRENT_YEARS <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">2019</span>, end_year)</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>    CURRENT_DATA <span class="ot">&lt;-</span> <span class="fu">map</span>(CURRENT_YEARS, <span class="cf">function</span>(yy){</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>      current_url <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"https://www.census.gov/construction/bps/xls/msaannual_{yy}99.xls"</span>)</span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>      temp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>()</span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(current_url, <span class="at">destfile =</span> temp, <span class="at">mode=</span><span class="st">"wb"</span>)</span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>      fallback <span class="ot">&lt;-</span> <span class="cf">function</span>(.f1, .f2){</span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(...){</span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a>          <span class="fu">tryCatch</span>(<span class="fu">.f1</span>(...), </span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a>                   <span class="at">error=</span><span class="cf">function</span>(e) <span class="fu">.f2</span>(...))</span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a>      reader <span class="ot">&lt;-</span> <span class="fu">fallback</span>(read_xlsx, read_xls)</span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a>      <span class="fu">reader</span>(temp, <span class="at">skip=</span><span class="dv">5</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a>        <span class="fu">na.omit</span>() <span class="sc">|&gt;</span></span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(CBSA, Total) <span class="sc">|&gt;</span></span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">year =</span> yy) <span class="sc">|&gt;</span></span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(<span class="at">new_housing_units_permitted =</span> Total)</span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a>    ALL_DATA <span class="ot">&lt;-</span> <span class="fu">rbind</span>(HISTORICAL_DATA, CURRENT_DATA)</span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(ALL_DATA, fname)</span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(fname, <span class="at">show_col_types=</span><span class="cn">FALSE</span>)</span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a>PERMITS <span class="ot">&lt;-</span> <span class="fu">get_building_permits</span>()</span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------------------------------------------</span></span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a><span class="do">## Download the latest NAICS data schema</span></span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a>get_bls_industry_codes <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>, <span class="st">"bls_industry_codes.csv"</span>)</span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dplyr)</span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidyr)</span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(readr)</span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(fname)){</span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> <span class="fu">request</span>(<span class="st">"https://www.bls.gov"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_url_path</span>(<span class="st">"cew"</span>, <span class="st">"classifications"</span>, <span class="st">"industry"</span>, <span class="st">"industry-titles.htm"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_headers</span>(<span class="st">`</span><span class="at">User-Agent</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:143.0) Gecko/20100101 Firefox/143.0"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_error</span>(<span class="at">is_error =</span> \(resp) <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_perform</span>()</span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resp_check_status</span>(resp)</span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a>    naics_table <span class="ot">&lt;-</span> <span class="fu">resp_body_html</span>(resp) <span class="sc">|&gt;</span></span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a>      <span class="fu">html_element</span>(<span class="st">"#naics_titles"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a>      <span class="fu">html_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">title =</span> <span class="fu">str_trim</span>(<span class="fu">str_remove</span>(<span class="fu">str_remove</span>(<span class="st">`</span><span class="at">Industry Title</span><span class="st">`</span>, Code), <span class="st">"NAICS"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="st">`</span><span class="at">Industry Title</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">depth =</span> <span class="fu">if_else</span>(<span class="fu">nchar</span>(Code) <span class="sc">&lt;=</span> <span class="dv">5</span>, <span class="fu">nchar</span>(Code) <span class="sc">-</span> <span class="dv">1</span>, <span class="cn">NA</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(depth))</span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These were looked up manually on bls.gov after finding </span></span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># they were presented as ranges. Since there are only three</span></span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it was easier to manually handle than to special-case everything else</span></span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a>    naics_missing <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(</span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span>Code, <span class="sc">~</span>title, <span class="sc">~</span>depth, </span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a>      <span class="st">"31"</span>, <span class="st">"Manufacturing"</span>, <span class="dv">1</span>,</span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a>      <span class="st">"32"</span>, <span class="st">"Manufacturing"</span>, <span class="dv">1</span>,</span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a>      <span class="st">"33"</span>, <span class="st">"Manufacturing"</span>, <span class="dv">1</span>,</span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a>      <span class="st">"44"</span>, <span class="st">"Retail"</span>, <span class="dv">1</span>, </span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a>      <span class="st">"45"</span>, <span class="st">"Retail"</span>, <span class="dv">1</span>,</span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a>      <span class="st">"48"</span>, <span class="st">"Transportation and Warehousing"</span>, <span class="dv">1</span>, </span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a>      <span class="st">"49"</span>, <span class="st">"Transportation and Warehousing"</span>, <span class="dv">1</span></span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-197"><a href="#cb24-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-198"><a href="#cb24-198" aria-hidden="true" tabindex="-1"></a>    naics_table <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(naics_table, naics_missing)</span>
<span id="cb24-199"><a href="#cb24-199" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a>    naics_table <span class="ot">&lt;-</span> naics_table <span class="sc">|&gt;</span> </span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(depth <span class="sc">==</span> <span class="dv">4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">level4_title=</span>title) <span class="sc">|&gt;</span> </span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">level1_code =</span> <span class="fu">str_sub</span>(Code, <span class="at">end=</span><span class="dv">2</span>), </span>
<span id="cb24-204"><a href="#cb24-204" aria-hidden="true" tabindex="-1"></a>             <span class="at">level2_code =</span> <span class="fu">str_sub</span>(Code, <span class="at">end=</span><span class="dv">3</span>), </span>
<span id="cb24-205"><a href="#cb24-205" aria-hidden="true" tabindex="-1"></a>             <span class="at">level3_code =</span> <span class="fu">str_sub</span>(Code, <span class="at">end=</span><span class="dv">4</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-206"><a href="#cb24-206" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(naics_table, <span class="fu">join_by</span>(level1_code <span class="sc">==</span> Code)) <span class="sc">|&gt;</span></span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">level1_title=</span>title) <span class="sc">|&gt;</span></span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(naics_table, <span class="fu">join_by</span>(level2_code <span class="sc">==</span> Code)) <span class="sc">|&gt;</span></span>
<span id="cb24-209"><a href="#cb24-209" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">level2_title=</span>title) <span class="sc">|&gt;</span></span>
<span id="cb24-210"><a href="#cb24-210" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(naics_table, <span class="fu">join_by</span>(level3_code <span class="sc">==</span> Code)) <span class="sc">|&gt;</span></span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">level3_title=</span>title) <span class="sc">|&gt;</span></span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">starts_with</span>(<span class="st">"depth"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">level4_code =</span> Code) <span class="sc">|&gt;</span></span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(level1_title, level2_title, level3_title, level4_title, </span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a>             level1_code,  level2_code,  level3_code,  level4_code) <span class="sc">|&gt;</span></span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a>      <span class="fu">drop_na</span>() <span class="sc">|&gt;</span></span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"code"</span>), as.integer))</span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(naics_table, fname)</span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(fname, <span class="at">show_col_types=</span><span class="cn">FALSE</span>)</span>
<span id="cb24-223"><a href="#cb24-223" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-224"><a href="#cb24-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a>INDUSTRY_CODES <span class="ot">&lt;-</span> <span class="fu">get_bls_industry_codes</span>()</span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------------------------------------------</span></span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a><span class="do">## Download the BLS Quarterly Census of Employment and Wages</span></span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb24-231"><a href="#cb24-231" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb24-232"><a href="#cb24-232" aria-hidden="true" tabindex="-1"></a>get_bls_qcew_annual_averages <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">start_year=</span><span class="dv">2009</span>, <span class="at">end_year=</span><span class="dv">2023</span>){</span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"bls_qcew_{start_year}_{end_year}.csv.gz"</span>)</span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>, fname)</span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a>  YEARS <span class="ot">&lt;-</span> <span class="fu">seq</span>(start_year, end_year)</span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a>  YEARS <span class="ot">&lt;-</span> YEARS[YEARS <span class="sc">!=</span> <span class="dv">2020</span>] <span class="co"># Drop Covid year to match ACS</span></span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-239"><a href="#cb24-239" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(fname)){</span>
<span id="cb24-240"><a href="#cb24-240" aria-hidden="true" tabindex="-1"></a>    ALL_DATA <span class="ot">&lt;-</span> <span class="fu">map</span>(YEARS, <span class="at">.progress=</span><span class="cn">TRUE</span>, <span class="fu">possibly</span>(<span class="cf">function</span>(yy){</span>
<span id="cb24-241"><a href="#cb24-241" aria-hidden="true" tabindex="-1"></a>      fname_inner <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"mp02"</span>, <span class="fu">glue</span>(<span class="st">"{yy}_qcew_annual_singlefile.zip"</span>))</span>
<span id="cb24-242"><a href="#cb24-242" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-243"><a href="#cb24-243" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(fname_inner)){</span>
<span id="cb24-244"><a href="#cb24-244" aria-hidden="true" tabindex="-1"></a>        <span class="fu">request</span>(<span class="st">"https://www.bls.gov"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-245"><a href="#cb24-245" aria-hidden="true" tabindex="-1"></a>          <span class="fu">req_url_path</span>(<span class="st">"cew"</span>, <span class="st">"data"</span>, <span class="st">"files"</span>, yy, <span class="st">"csv"</span>,</span>
<span id="cb24-246"><a href="#cb24-246" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">glue</span>(<span class="st">"{yy}_annual_singlefile.zip"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-247"><a href="#cb24-247" aria-hidden="true" tabindex="-1"></a>          <span class="fu">req_headers</span>(<span class="st">`</span><span class="at">User-Agent</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:143.0) Gecko/20100101 Firefox/143.0"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-248"><a href="#cb24-248" aria-hidden="true" tabindex="-1"></a>          <span class="fu">req_retry</span>(<span class="at">max_tries=</span><span class="dv">5</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-249"><a href="#cb24-249" aria-hidden="true" tabindex="-1"></a>          <span class="fu">req_perform</span>(fname_inner)</span>
<span id="cb24-250"><a href="#cb24-250" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb24-251"><a href="#cb24-251" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-252"><a href="#cb24-252" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">file.info</span>(fname_inner)<span class="sc">$</span>size <span class="sc">&lt;</span> <span class="fl">755e5</span>){</span>
<span id="cb24-253"><a href="#cb24-253" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="fu">sQuote</span>(fname_inner), <span class="st">"appears corrupted. Please delete and retry this step."</span>)</span>
<span id="cb24-254"><a href="#cb24-254" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb24-255"><a href="#cb24-255" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb24-256"><a href="#cb24-256" aria-hidden="true" tabindex="-1"></a>      <span class="fu">read_csv</span>(fname_inner, </span>
<span id="cb24-257"><a href="#cb24-257" aria-hidden="true" tabindex="-1"></a>               <span class="at">show_col_types=</span><span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-258"><a href="#cb24-258" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">YEAR =</span> yy) <span class="sc">|&gt;</span></span>
<span id="cb24-259"><a href="#cb24-259" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(area_fips, </span>
<span id="cb24-260"><a href="#cb24-260" aria-hidden="true" tabindex="-1"></a>               industry_code, </span>
<span id="cb24-261"><a href="#cb24-261" aria-hidden="true" tabindex="-1"></a>               annual_avg_emplvl, </span>
<span id="cb24-262"><a href="#cb24-262" aria-hidden="true" tabindex="-1"></a>               total_annual_wages, </span>
<span id="cb24-263"><a href="#cb24-263" aria-hidden="true" tabindex="-1"></a>               YEAR) <span class="sc">|&gt;</span></span>
<span id="cb24-264"><a href="#cb24-264" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="fu">nchar</span>(industry_code) <span class="sc">&lt;=</span> <span class="dv">5</span>, </span>
<span id="cb24-265"><a href="#cb24-265" aria-hidden="true" tabindex="-1"></a>               <span class="fu">str_starts</span>(area_fips, <span class="st">"C"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-266"><a href="#cb24-266" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="fu">str_detect</span>(industry_code, <span class="st">"-"</span>, <span class="at">negate=</span><span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-267"><a href="#cb24-267" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">FIPS =</span> area_fips, </span>
<span id="cb24-268"><a href="#cb24-268" aria-hidden="true" tabindex="-1"></a>               <span class="at">INDUSTRY =</span> <span class="fu">as.integer</span>(industry_code), </span>
<span id="cb24-269"><a href="#cb24-269" aria-hidden="true" tabindex="-1"></a>               <span class="at">EMPLOYMENT =</span> <span class="fu">as.integer</span>(annual_avg_emplvl), </span>
<span id="cb24-270"><a href="#cb24-270" aria-hidden="true" tabindex="-1"></a>               <span class="at">TOTAL_WAGES =</span> total_annual_wages) <span class="sc">|&gt;</span></span>
<span id="cb24-271"><a href="#cb24-271" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span>area_fips, </span>
<span id="cb24-272"><a href="#cb24-272" aria-hidden="true" tabindex="-1"></a>               <span class="sc">-</span>industry_code, </span>
<span id="cb24-273"><a href="#cb24-273" aria-hidden="true" tabindex="-1"></a>               <span class="sc">-</span>annual_avg_emplvl, </span>
<span id="cb24-274"><a href="#cb24-274" aria-hidden="true" tabindex="-1"></a>               <span class="sc">-</span>total_annual_wages) <span class="sc">|&gt;</span></span>
<span id="cb24-275"><a href="#cb24-275" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 10 is a special value: "all industries" , so omit</span></span>
<span id="cb24-276"><a href="#cb24-276" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(INDUSTRY <span class="sc">!=</span> <span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-277"><a href="#cb24-277" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">AVG_WAGE =</span> TOTAL_WAGES <span class="sc">/</span> EMPLOYMENT)</span>
<span id="cb24-278"><a href="#cb24-278" aria-hidden="true" tabindex="-1"></a>    })) <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>()</span>
<span id="cb24-279"><a href="#cb24-279" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-280"><a href="#cb24-280" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(ALL_DATA, fname)</span>
<span id="cb24-281"><a href="#cb24-281" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-282"><a href="#cb24-282" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-283"><a href="#cb24-283" aria-hidden="true" tabindex="-1"></a>  ALL_DATA <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fname, <span class="at">show_col_types=</span><span class="cn">FALSE</span>)</span>
<span id="cb24-284"><a href="#cb24-284" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-285"><a href="#cb24-285" aria-hidden="true" tabindex="-1"></a>  ALL_DATA_YEARS <span class="ot">&lt;-</span> <span class="fu">unique</span>(ALL_DATA<span class="sc">$</span>YEAR)</span>
<span id="cb24-286"><a href="#cb24-286" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-287"><a href="#cb24-287" aria-hidden="true" tabindex="-1"></a>  YEARS_DIFF <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(YEARS, ALL_DATA_YEARS)</span>
<span id="cb24-288"><a href="#cb24-288" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-289"><a href="#cb24-289" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(YEARS_DIFF) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb24-290"><a href="#cb24-290" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Download failed for the following years: "</span>, YEARS_DIFF, </span>
<span id="cb24-291"><a href="#cb24-291" aria-hidden="true" tabindex="-1"></a>         <span class="st">". Please delete intermediate files and try again."</span>)</span>
<span id="cb24-292"><a href="#cb24-292" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-293"><a href="#cb24-293" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-294"><a href="#cb24-294" aria-hidden="true" tabindex="-1"></a>  ALL_DATA</span>
<span id="cb24-295"><a href="#cb24-295" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-296"><a href="#cb24-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-297"><a href="#cb24-297" aria-hidden="true" tabindex="-1"></a>WAGES <span class="ot">&lt;-</span> <span class="fu">get_bls_qcew_annual_averages</span>()</span>
<span id="cb24-298"><a href="#cb24-298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-299"><a href="#cb24-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-300"><a href="#cb24-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-301"><a href="#cb24-301" aria-hidden="true" tabindex="-1"></a><span class="fu"># Task 2: Multi-Table Questions</span></span>
<span id="cb24-302"><a href="#cb24-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-303"><a href="#cb24-303" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>1. Which CBSA (by name) permitted the largest number of new housing units in the decade from 2010 to 2019 (inclusive)?</span>
<span id="cb24-304"><a href="#cb24-304" aria-hidden="true" tabindex="-1"></a>The Houston–Sugar Land–Baytown, TX Metropolitan Area (CBSA 26420) permitted the largest number of new housing units during the decade from 2010 to 2019.</span>
<span id="cb24-305"><a href="#cb24-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-306"><a href="#cb24-306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-307"><a href="#cb24-307" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-308"><a href="#cb24-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-309"><a href="#cb24-309" aria-hidden="true" tabindex="-1"></a>top_cbsa <span class="ot">&lt;-</span> PERMITS <span class="sc">|&gt;</span></span>
<span id="cb24-310"><a href="#cb24-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">between</span>(year, <span class="dv">2010</span>, <span class="dv">2019</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-311"><a href="#cb24-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(CBSA) <span class="sc">|&gt;</span></span>
<span id="cb24-312"><a href="#cb24-312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">total_units =</span> <span class="fu">sum</span>(new_housing_units_permitted, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-313"><a href="#cb24-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(HOUSEHOLDS, <span class="fu">join_by</span> (<span class="st">"CBSA"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-314"><a href="#cb24-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_units)) <span class="sc">|&gt;</span></span>
<span id="cb24-315"><a href="#cb24-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb24-316"><a href="#cb24-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-317"><a href="#cb24-317" aria-hidden="true" tabindex="-1"></a>top_cbsa <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">result =</span> <span class="fu">paste</span>(CBSA, NAME)) <span class="sc">|&gt;</span> <span class="fu">pull</span>(result)</span>
<span id="cb24-318"><a href="#cb24-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-319"><a href="#cb24-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-320"><a href="#cb24-320" aria-hidden="true" tabindex="-1"></a>*2. In what year did Albuquerque, NM (CBSA Number 10740) permit the most new housing units?</span>
<span id="cb24-321"><a href="#cb24-321" aria-hidden="true" tabindex="-1"></a>Although 2021 recorded the highest number of new housing permits (4,021 units),this appears to be a COVID-19 data artifact,and the actual peak year is 2017.</span>
<span id="cb24-322"><a href="#cb24-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-323"><a href="#cb24-323" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-324"><a href="#cb24-324" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-325"><a href="#cb24-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-326"><a href="#cb24-326" aria-hidden="true" tabindex="-1"></a>cbsa_names <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb24-327"><a href="#cb24-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(GEOID, NAME) <span class="sc">|&gt;</span></span>
<span id="cb24-328"><a href="#cb24-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GEOID =</span> <span class="fu">as.integer</span>(GEOID))</span>
<span id="cb24-329"><a href="#cb24-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-330"><a href="#cb24-330" aria-hidden="true" tabindex="-1"></a>albuquerque_top_year <span class="ot">&lt;-</span> PERMITS <span class="sc">|&gt;</span></span>
<span id="cb24-331"><a href="#cb24-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(CBSA <span class="sc">==</span> <span class="dv">10740</span>, year <span class="sc">!=</span> <span class="dv">2021</span>) <span class="sc">|&gt;</span>  <span class="co"># exclude 2021</span></span>
<span id="cb24-332"><a href="#cb24-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(CBSA, year) <span class="sc">|&gt;</span></span>
<span id="cb24-333"><a href="#cb24-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_units =</span> <span class="fu">sum</span>(new_housing_units_permitted, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-334"><a href="#cb24-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(cbsa_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"CBSA"</span> <span class="ot">=</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span>  </span>
<span id="cb24-335"><a href="#cb24-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_units)) <span class="sc">|&gt;</span></span>
<span id="cb24-336"><a href="#cb24-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb24-337"><a href="#cb24-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-338"><a href="#cb24-338" aria-hidden="true" tabindex="-1"></a>albuquerque_top_year</span>
<span id="cb24-339"><a href="#cb24-339" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-340"><a href="#cb24-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-341"><a href="#cb24-341" aria-hidden="true" tabindex="-1"></a>*3. Which state (not CBSA) had the highest average individual income in 2015?</span>
<span id="cb24-342"><a href="#cb24-342" aria-hidden="true" tabindex="-1"></a>In 2015, the state with the highest average individual income was the District of Columbia</span>
<span id="cb24-343"><a href="#cb24-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-344"><a href="#cb24-344" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-345"><a href="#cb24-345" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-346"><a href="#cb24-346" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb24-347"><a href="#cb24-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-348"><a href="#cb24-348" aria-hidden="true" tabindex="-1"></a>state_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb24-349"><a href="#cb24-349" aria-hidden="true" tabindex="-1"></a>  <span class="at">abb  =</span> <span class="fu">c</span>(state.abb, <span class="st">"DC"</span>, <span class="st">"PR"</span>),</span>
<span id="cb24-350"><a href="#cb24-350" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(state.name, <span class="st">"District of Columbia"</span>, <span class="st">"Puerto Rico"</span>)</span>
<span id="cb24-351"><a href="#cb24-351" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-352"><a href="#cb24-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-353"><a href="#cb24-353" aria-hidden="true" tabindex="-1"></a>cbsa_2015 <span class="ot">&lt;-</span> INCOME <span class="sc">|&gt;</span></span>
<span id="cb24-354"><a href="#cb24-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(HOUSEHOLDS, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"GEOID"</span>, <span class="st">"NAME"</span>, <span class="st">"year"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-355"><a href="#cb24-355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(POPULATION, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"GEOID"</span>, <span class="st">"NAME"</span>, <span class="st">"year"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-356"><a href="#cb24-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2015</span>)</span>
<span id="cb24-357"><a href="#cb24-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-358"><a href="#cb24-358" aria-hidden="true" tabindex="-1"></a>cbsa_2015_calc <span class="ot">&lt;-</span> cbsa_2015 <span class="sc">|&gt;</span></span>
<span id="cb24-359"><a href="#cb24-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-360"><a href="#cb24-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_income_cbsa =</span> household_income <span class="sc">*</span> households,</span>
<span id="cb24-361"><a href="#cb24-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_extract</span>(NAME, <span class="st">"(?&lt;=, )[A-Z]{2}"</span>)  </span>
<span id="cb24-362"><a href="#cb24-362" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-363"><a href="#cb24-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-364"><a href="#cb24-364" aria-hidden="true" tabindex="-1"></a>state_2015 <span class="ot">&lt;-</span> cbsa_2015_calc <span class="sc">|&gt;</span></span>
<span id="cb24-365"><a href="#cb24-365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state) <span class="sc">|&gt;</span></span>
<span id="cb24-366"><a href="#cb24-366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb24-367"><a href="#cb24-367" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_income =</span> <span class="fu">sum</span>(total_income_cbsa, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-368"><a href="#cb24-368" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_population =</span> <span class="fu">sum</span>(population, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-369"><a href="#cb24-369" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb24-370"><a href="#cb24-370" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-371"><a href="#cb24-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_individual_income =</span> total_income <span class="sc">/</span> total_population) <span class="sc">|&gt;</span></span>
<span id="cb24-372"><a href="#cb24-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(state_df, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"state"</span> <span class="ot">=</span> <span class="st">"abb"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-373"><a href="#cb24-373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_individual_income))</span>
<span id="cb24-374"><a href="#cb24-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-375"><a href="#cb24-375" aria-hidden="true" tabindex="-1"></a>top_state_2015 <span class="ot">&lt;-</span> state_2015 <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb24-376"><a href="#cb24-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-377"><a href="#cb24-377" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(top_state_2015) </span>
<span id="cb24-378"><a href="#cb24-378" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-379"><a href="#cb24-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-380"><a href="#cb24-380" aria-hidden="true" tabindex="-1"></a>*4. What is the last year in which the NYC CBSA had the most data scientists in the country? </span>
<span id="cb24-381"><a href="#cb24-381" aria-hidden="true" tabindex="-1"></a>The last year New York had the most data scientists in the U.S. was 2015.</span>
<span id="cb24-382"><a href="#cb24-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-383"><a href="#cb24-383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-384"><a href="#cb24-384" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-385"><a href="#cb24-385" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb24-386"><a href="#cb24-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-387"><a href="#cb24-387" aria-hidden="true" tabindex="-1"></a>WAGES_CLEAN <span class="ot">&lt;-</span> WAGES <span class="sc">|&gt;</span></span>
<span id="cb24-388"><a href="#cb24-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CBSA_join =</span> <span class="fu">as.double</span>(<span class="fu">paste0</span>(<span class="fu">str_remove</span>(FIPS, <span class="st">"^C"</span>), <span class="st">"0"</span>)))</span>
<span id="cb24-389"><a href="#cb24-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-390"><a href="#cb24-390" aria-hidden="true" tabindex="-1"></a>cbsa_names <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb24-391"><a href="#cb24-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(GEOID, NAME) <span class="sc">|&gt;</span></span>
<span id="cb24-392"><a href="#cb24-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GEOID =</span> <span class="fu">as.double</span>(GEOID))</span>
<span id="cb24-393"><a href="#cb24-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-394"><a href="#cb24-394" aria-hidden="true" tabindex="-1"></a>data_sci <span class="ot">&lt;-</span> WAGES_CLEAN <span class="sc">|&gt;</span></span>
<span id="cb24-395"><a href="#cb24-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(INDUSTRY <span class="sc">==</span> <span class="dv">5182</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-396"><a href="#cb24-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR, CBSA_join) <span class="sc">|&gt;</span></span>
<span id="cb24-397"><a href="#cb24-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">EMPLOYMENT =</span> <span class="fu">sum</span>(EMPLOYMENT, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb24-398"><a href="#cb24-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-399"><a href="#cb24-399" aria-hidden="true" tabindex="-1"></a>top_cbsa_each_year <span class="ot">&lt;-</span> data_sci <span class="sc">|&gt;</span></span>
<span id="cb24-400"><a href="#cb24-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(cbsa_names, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"CBSA_join"</span> <span class="ot">=</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-401"><a href="#cb24-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">|&gt;</span></span>
<span id="cb24-402"><a href="#cb24-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(EMPLOYMENT, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-403"><a href="#cb24-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb24-404"><a href="#cb24-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(YEAR, NAME, EMPLOYMENT)</span>
<span id="cb24-405"><a href="#cb24-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-406"><a href="#cb24-406" aria-hidden="true" tabindex="-1"></a>nyc_last_year <span class="ot">&lt;-</span> top_cbsa_each_year <span class="sc">|&gt;</span></span>
<span id="cb24-407"><a href="#cb24-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(NAME, <span class="st">"New York"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-408"><a href="#cb24-408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">last_year_nyc_led =</span> <span class="fu">max</span>(YEAR, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb24-409"><a href="#cb24-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-410"><a href="#cb24-410" aria-hidden="true" tabindex="-1"></a>top_cbsa_each_year</span>
<span id="cb24-411"><a href="#cb24-411" aria-hidden="true" tabindex="-1"></a>nyc_last_year</span>
<span id="cb24-412"><a href="#cb24-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-413"><a href="#cb24-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-414"><a href="#cb24-414" aria-hidden="true" tabindex="-1"></a>*5. What fraction of total wages in the NYC CBSA was earned by people employed in the finance and insurance industries (NAICS code 52)? In what year did this fraction peak? </span>
<span id="cb24-415"><a href="#cb24-415" aria-hidden="true" tabindex="-1"></a>In the NYC CBSA, the finance and insurance industries made up 16% of total wages, peaking in 2021.</span>
<span id="cb24-416"><a href="#cb24-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-417"><a href="#cb24-417" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-418"><a href="#cb24-418" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-419"><a href="#cb24-419" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb24-420"><a href="#cb24-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-421"><a href="#cb24-421" aria-hidden="true" tabindex="-1"></a>WAGES_join <span class="ot">&lt;-</span> WAGES <span class="sc">|&gt;</span></span>
<span id="cb24-422"><a href="#cb24-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CBSA_join =</span> <span class="fu">as.double</span>(<span class="fu">paste0</span>(<span class="fu">str_remove</span>(FIPS, <span class="st">"C"</span>), <span class="st">"0"</span>)))</span>
<span id="cb24-423"><a href="#cb24-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-424"><a href="#cb24-424" aria-hidden="true" tabindex="-1"></a>nyc_wages <span class="ot">&lt;-</span> WAGES_join <span class="sc">|&gt;</span></span>
<span id="cb24-425"><a href="#cb24-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(CBSA_join <span class="sc">==</span> <span class="dv">35620</span>)</span>
<span id="cb24-426"><a href="#cb24-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-427"><a href="#cb24-427" aria-hidden="true" tabindex="-1"></a>total_wages <span class="ot">&lt;-</span> nyc_wages <span class="sc">|&gt;</span></span>
<span id="cb24-428"><a href="#cb24-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">|&gt;</span></span>
<span id="cb24-429"><a href="#cb24-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_wages_all =</span> <span class="fu">sum</span>(TOTAL_WAGES, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb24-430"><a href="#cb24-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-431"><a href="#cb24-431" aria-hidden="true" tabindex="-1"></a>finance_wages <span class="ot">&lt;-</span> nyc_wages <span class="sc">|&gt;</span></span>
<span id="cb24-432"><a href="#cb24-432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_starts</span>(<span class="fu">as.character</span>(INDUSTRY), <span class="st">"52"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-433"><a href="#cb24-433" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(YEAR) <span class="sc">|&gt;</span></span>
<span id="cb24-434"><a href="#cb24-434" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_wages_finance =</span> <span class="fu">sum</span>(TOTAL_WAGES, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb24-435"><a href="#cb24-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-436"><a href="#cb24-436" aria-hidden="true" tabindex="-1"></a>nyc_finance_fraction <span class="ot">&lt;-</span> total_wages <span class="sc">|&gt;</span></span>
<span id="cb24-437"><a href="#cb24-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(finance_wages, <span class="at">by =</span> <span class="st">"YEAR"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-438"><a href="#cb24-438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fraction =</span> total_wages_finance <span class="sc">/</span> total_wages_all,</span>
<span id="cb24-439"><a href="#cb24-439" aria-hidden="true" tabindex="-1"></a>         <span class="at">percent =</span> fraction <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-440"><a href="#cb24-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(fraction))</span>
<span id="cb24-441"><a href="#cb24-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-442"><a href="#cb24-442" aria-hidden="true" tabindex="-1"></a>peak_year <span class="ot">&lt;-</span> nyc_finance_fraction <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb24-443"><a href="#cb24-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-444"><a href="#cb24-444" aria-hidden="true" tabindex="-1"></a>peak_year</span>
<span id="cb24-445"><a href="#cb24-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-446"><a href="#cb24-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-447"><a href="#cb24-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-448"><a href="#cb24-448" aria-hidden="true" tabindex="-1"></a><span class="fu"># Task 3: Initial Visualizations</span></span>
<span id="cb24-449"><a href="#cb24-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-450"><a href="#cb24-450" aria-hidden="true" tabindex="-1"></a>*1. The relationship between monthly rent and average household income per CBSA in 2009. </span>
<span id="cb24-451"><a href="#cb24-451" aria-hidden="true" tabindex="-1"></a>The scatterplot shows a clear positive relationship between median household income and monthly rent across CBSAs in 2009.</span>
<span id="cb24-452"><a href="#cb24-452" aria-hidden="true" tabindex="-1"></a>In general, areas with higher incomes also have higher rents. </span>
<span id="cb24-453"><a href="#cb24-453" aria-hidden="true" tabindex="-1"></a>Since both axes are on a log scale, the relationship is roughly proportional — when income doubles, rent tends to rise by about 1.5 to 2 times. </span>
<span id="cb24-454"><a href="#cb24-454" aria-hidden="true" tabindex="-1"></a>Most points are close to the trend line, indicating a strong correlation, while a few outliers suggest local differences in housing markets or cost of living.</span>
<span id="cb24-455"><a href="#cb24-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-456"><a href="#cb24-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-457"><a href="#cb24-457" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-458"><a href="#cb24-458" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb24-459"><a href="#cb24-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-460"><a href="#cb24-460" aria-hidden="true" tabindex="-1"></a>rent_income_2009 <span class="ot">&lt;-</span> RENT <span class="sc">|&gt;</span></span>
<span id="cb24-461"><a href="#cb24-461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2009</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-462"><a href="#cb24-462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(GEOID, NAME, monthly_rent) <span class="sc">|&gt;</span></span>
<span id="cb24-463"><a href="#cb24-463" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(INCOME <span class="sc">|&gt;</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2009</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(GEOID, household_income),</span>
<span id="cb24-464"><a href="#cb24-464" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="st">"GEOID"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-465"><a href="#cb24-465" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(monthly_rent), <span class="sc">!</span><span class="fu">is.na</span>(household_income))</span>
<span id="cb24-466"><a href="#cb24-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-467"><a href="#cb24-467" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rent_income_2009, <span class="fu">aes</span>(<span class="at">x =</span> household_income, <span class="at">y =</span> monthly_rent)) <span class="sc">+</span></span>
<span id="cb24-468"><a href="#cb24-468" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb24-469"><a href="#cb24-469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb24-470"><a href="#cb24-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Monthly Rent vs Household Income (CBSA, 2009)"</span>,</span>
<span id="cb24-471"><a href="#cb24-471" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Median Household Income"</span>,</span>
<span id="cb24-472"><a href="#cb24-472" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Median Monthly Rent"</span>) <span class="sc">+</span></span>
<span id="cb24-473"><a href="#cb24-473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb24-474"><a href="#cb24-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-475"><a href="#cb24-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-476"><a href="#cb24-476" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rent_income_2009, <span class="fu">aes</span>(household_income, monthly_rent)) <span class="sc">+</span></span>
<span id="cb24-477"><a href="#cb24-477" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb24-478"><a href="#cb24-478" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb24-479"><a href="#cb24-479" aria-hidden="true" tabindex="-1"></a>   <span class="fu">scale_x_log10</span>() <span class="sc">+</span> <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb24-480"><a href="#cb24-480" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Monthly Rent vs Household Income (Log Scales, 2009)"</span>,</span>
<span id="cb24-481"><a href="#cb24-481" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Median Household Income (log)"</span>,</span>
<span id="cb24-482"><a href="#cb24-482" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Median Monthly Rent (log)"</span>) <span class="sc">+</span></span>
<span id="cb24-483"><a href="#cb24-483" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme_minimal</span>()</span>
<span id="cb24-484"><a href="#cb24-484" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-485"><a href="#cb24-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-486"><a href="#cb24-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-487"><a href="#cb24-487" aria-hidden="true" tabindex="-1"></a>*2. The relationship between total employment and total employment in the health care and social services sector (NAICS 62) across different CBSAs.</span>
<span id="cb24-488"><a href="#cb24-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-489"><a href="#cb24-489" aria-hidden="true" tabindex="-1"></a>I selected the three most populous CBSAs and visualized how employment in the Health Care and Social Assistance sector (NAICS 62) changed over the last five years.</span>
<span id="cb24-490"><a href="#cb24-490" aria-hidden="true" tabindex="-1"></a>The bars show total employment in this sector, and the lines show its share of total employment in each CBSA.</span>
<span id="cb24-491"><a href="#cb24-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-492"><a href="#cb24-492" aria-hidden="true" tabindex="-1"></a>From 2018 to 2023, both New York and Los Angeles saw growth in health and social services employment, with New York consistently leading in size and share. New York’s employment peaked in 2021 at 5.6 million (about 15% of total jobs) before slightly declining and recovering by 2023. Los Angeles also grew steadily from 3.6 to 4.0 million, with its share rising from 11.7% to 12.8%. Both cities hit their highest levels during the pandemic, reflecting increased healthcare demand, and have since stabilized at historically high levels.</span>
<span id="cb24-493"><a href="#cb24-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-494"><a href="#cb24-494" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-495"><a href="#cb24-495" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-496"><a href="#cb24-496" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb24-497"><a href="#cb24-497" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb24-498"><a href="#cb24-498" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb24-499"><a href="#cb24-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-500"><a href="#cb24-500" aria-hidden="true" tabindex="-1"></a>yrs <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(WAGES<span class="sc">$</span>YEAR))</span>
<span id="cb24-501"><a href="#cb24-501" aria-hidden="true" tabindex="-1"></a>latest_years <span class="ot">&lt;-</span> <span class="fu">tail</span>(yrs[yrs <span class="sc">!=</span> <span class="dv">2020</span>], <span class="dv">5</span>)</span>
<span id="cb24-502"><a href="#cb24-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-503"><a href="#cb24-503" aria-hidden="true" tabindex="-1"></a>cbsa_names <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb24-504"><a href="#cb24-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="fu">max</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-505"><a href="#cb24-505" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(GEOID, NAME) <span class="sc">|&gt;</span></span>
<span id="cb24-506"><a href="#cb24-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GEOID =</span> <span class="fu">as.integer</span>(GEOID))</span>
<span id="cb24-507"><a href="#cb24-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-508"><a href="#cb24-508" aria-hidden="true" tabindex="-1"></a>available_cbsa <span class="ot">&lt;-</span> WAGES <span class="sc">|&gt;</span></span>
<span id="cb24-509"><a href="#cb24-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">%in%</span> latest_years, <span class="fu">str_starts</span>(FIPS, <span class="st">"C"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-510"><a href="#cb24-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">CBSA =</span> <span class="fu">as.integer</span>(<span class="fu">paste0</span>(<span class="fu">str_sub</span>(FIPS, <span class="dv">2</span>), <span class="st">"0"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb24-511"><a href="#cb24-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(CBSA)</span>
<span id="cb24-512"><a href="#cb24-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-513"><a href="#cb24-513" aria-hidden="true" tabindex="-1"></a>top2_cbsa <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb24-514"><a href="#cb24-514" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> latest_years) <span class="sc">|&gt;</span></span>
<span id="cb24-515"><a href="#cb24-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID, NAME) <span class="sc">|&gt;</span></span>
<span id="cb24-516"><a href="#cb24-516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">avg_pop =</span> <span class="fu">mean</span>(population, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-517"><a href="#cb24-517" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GEOID =</span> <span class="fu">as.integer</span>(GEOID)) <span class="sc">|&gt;</span></span>
<span id="cb24-518"><a href="#cb24-518" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(available_cbsa, <span class="fu">join_by</span>(GEOID <span class="sc">==</span> CBSA)) <span class="sc">|&gt;</span></span>
<span id="cb24-519"><a href="#cb24-519" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_pop)) <span class="sc">|&gt;</span></span>
<span id="cb24-520"><a href="#cb24-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-521"><a href="#cb24-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(GEOID)</span>
<span id="cb24-522"><a href="#cb24-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-523"><a href="#cb24-523" aria-hidden="true" tabindex="-1"></a>wages_health <span class="ot">&lt;-</span> WAGES <span class="sc">|&gt;</span></span>
<span id="cb24-524"><a href="#cb24-524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">%in%</span> latest_years, <span class="fu">str_starts</span>(FIPS, <span class="st">"C"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-525"><a href="#cb24-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CBSA =</span> <span class="fu">as.integer</span>(<span class="fu">paste0</span>(<span class="fu">str_sub</span>(FIPS, <span class="dv">2</span>), <span class="st">"0"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb24-526"><a href="#cb24-526" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(CBSA, YEAR) <span class="sc">|&gt;</span></span>
<span id="cb24-527"><a href="#cb24-527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb24-528"><a href="#cb24-528" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_emp  =</span> <span class="fu">sum</span>(EMPLOYMENT, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-529"><a href="#cb24-529" aria-hidden="true" tabindex="-1"></a>    <span class="at">health_emp =</span> <span class="fu">sum</span>(EMPLOYMENT[<span class="fu">str_starts</span>(<span class="fu">as.character</span>(INDUSTRY), <span class="st">"62"</span>)], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-530"><a href="#cb24-530" aria-hidden="true" tabindex="-1"></a>    <span class="at">ratio =</span> health_emp <span class="sc">/</span> total_emp,</span>
<span id="cb24-531"><a href="#cb24-531" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb24-532"><a href="#cb24-532" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-533"><a href="#cb24-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-534"><a href="#cb24-534" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> wages_health <span class="sc">|&gt;</span></span>
<span id="cb24-535"><a href="#cb24-535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(cbsa_names, <span class="fu">join_by</span>(CBSA <span class="sc">==</span> GEOID)) <span class="sc">|&gt;</span></span>
<span id="cb24-536"><a href="#cb24-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(CBSA <span class="sc">%in%</span> top2_cbsa) <span class="sc">|&gt;</span></span>
<span id="cb24-537"><a href="#cb24-537" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">City =</span> <span class="fu">str_trim</span>(<span class="fu">str_split_fixed</span>(NAME, <span class="st">"–"</span>, <span class="dv">2</span>)[,<span class="dv">1</span>])) <span class="sc">|&gt;</span></span>
<span id="cb24-538"><a href="#cb24-538" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(City, YEAR, health_emp, ratio) <span class="sc">|&gt;</span></span>
<span id="cb24-539"><a href="#cb24-539" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(City, YEAR)</span>
<span id="cb24-540"><a href="#cb24-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-541"><a href="#cb24-541" aria-hidden="true" tabindex="-1"></a>k  <span class="ot">&lt;-</span> <span class="fu">max</span>(plot_data<span class="sc">$</span>health_emp<span class="sc">/</span><span class="dv">1000</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">max</span>(plot_data<span class="sc">$</span>ratio, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-542"><a href="#cb24-542" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">&lt;-</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.65</span>)</span>
<span id="cb24-543"><a href="#cb24-543" aria-hidden="true" tabindex="-1"></a>bar_width <span class="ot">&lt;-</span> <span class="fl">0.45</span></span>
<span id="cb24-544"><a href="#cb24-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-545"><a href="#cb24-545" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(YEAR))) <span class="sc">+</span></span>
<span id="cb24-546"><a href="#cb24-546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> health_emp<span class="sc">/</span><span class="dv">1000</span>, <span class="at">fill =</span> City),</span>
<span id="cb24-547"><a href="#cb24-547" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> bar_width, <span class="at">position =</span> pd, <span class="at">alpha =</span> <span class="fl">0.70</span>) <span class="sc">+</span></span>
<span id="cb24-548"><a href="#cb24-548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> health_emp<span class="sc">/</span><span class="dv">1000</span>, <span class="at">label =</span> <span class="fu">comma</span>(health_emp), <span class="at">group =</span> City),</span>
<span id="cb24-549"><a href="#cb24-549" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> pd, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.25</span>, <span class="at">size =</span> <span class="fl">3.1</span>,</span>
<span id="cb24-550"><a href="#cb24-550" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb24-551"><a href="#cb24-551" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ratio <span class="sc">*</span> k, <span class="at">color =</span> City, <span class="at">group =</span> City),</span>
<span id="cb24-552"><a href="#cb24-552" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> pd, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb24-553"><a href="#cb24-553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> ratio <span class="sc">*</span> k, <span class="at">color =</span> City),</span>
<span id="cb24-554"><a href="#cb24-554" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> pd, <span class="at">size =</span> <span class="fl">2.2</span>) <span class="sc">+</span></span>
<span id="cb24-555"><a href="#cb24-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">y =</span> ratio <span class="sc">*</span> k, <span class="at">label =</span> <span class="fu">percent</span>(ratio, <span class="at">accuracy =</span> <span class="fl">0.1</span>),</span>
<span id="cb24-556"><a href="#cb24-556" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> City, <span class="at">group =</span> City),</span>
<span id="cb24-557"><a href="#cb24-557" aria-hidden="true" tabindex="-1"></a>            <span class="at">position =</span> pd, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.6</span>, <span class="at">size =</span> <span class="fl">3.1</span>,</span>
<span id="cb24-558"><a href="#cb24-558" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb24-559"><a href="#cb24-559" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb24-560"><a href="#cb24-560" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Employment in Health/Social (Thousands)"</span>,</span>
<span id="cb24-561"><a href="#cb24-561" aria-hidden="true" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> k, <span class="at">name =</span> <span class="st">"Share of Total Employment (%)"</span>,</span>
<span id="cb24-562"><a href="#cb24-562" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>))</span>
<span id="cb24-563"><a href="#cb24-563" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-564"><a href="#cb24-564" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-565"><a href="#cb24-565" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Health &amp; Social Services Employment — Top 2 CBSAs (by Population)"</span>,</span>
<span id="cb24-566"><a href="#cb24-566" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Employment (bars) &amp; Share (lines), "</span>,</span>
<span id="cb24-567"><a href="#cb24-567" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">min</span>(latest_years), <span class="st">"–"</span>, <span class="fu">max</span>(latest_years)),</span>
<span id="cb24-568"><a href="#cb24-568" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">fill =</span> <span class="st">"City"</span>, <span class="at">color =</span> <span class="st">"City"</span></span>
<span id="cb24-569"><a href="#cb24-569" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-570"><a href="#cb24-570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">2000000</span><span class="sc">/</span><span class="dv">1000</span>, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb24-571"><a href="#cb24-571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>) <span class="sc">+</span></span>
<span id="cb24-572"><a href="#cb24-572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb24-573"><a href="#cb24-573" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-574"><a href="#cb24-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-575"><a href="#cb24-575" aria-hidden="true" tabindex="-1"></a>*3. The evolution of average household size over time. Use different lines to represent different CBSAs. For a point of extra credit, use the gghighlight package to highlight the NYC and Los Angeles CBSAs in your visualization of household size over time.</span>
<span id="cb24-576"><a href="#cb24-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-577"><a href="#cb24-577" aria-hidden="true" tabindex="-1"></a>The chart shows how average household size changed across U.S. metro areas from 2009 to 2023.</span>
<span id="cb24-578"><a href="#cb24-578" aria-hidden="true" tabindex="-1"></a>Los Angeles (red) consistently had larger households, around 3.1–3.3 people, but has slowly declined since 2016.</span>
<span id="cb24-579"><a href="#cb24-579" aria-hidden="true" tabindex="-1"></a>New York (blue) maintained smaller households, around 2.6–2.8 people, with a slight drop after 2018.</span>
<span id="cb24-580"><a href="#cb24-580" aria-hidden="true" tabindex="-1"></a>Both cities show a gradual decrease, likely reflecting more single-person and smaller families.</span>
<span id="cb24-581"><a href="#cb24-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-582"><a href="#cb24-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-583"><a href="#cb24-583" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-584"><a href="#cb24-584" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb24-585"><a href="#cb24-585" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb24-586"><a href="#cb24-586" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb24-587"><a href="#cb24-587" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gghighlight)</span>
<span id="cb24-588"><a href="#cb24-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-589"><a href="#cb24-589" aria-hidden="true" tabindex="-1"></a>HH_SIZE <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb24-590"><a href="#cb24-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-591"><a href="#cb24-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(GEOID, NAME, year, population) <span class="sc">|&gt;</span></span>
<span id="cb24-592"><a href="#cb24-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb24-593"><a href="#cb24-593" aria-hidden="true" tabindex="-1"></a>    HOUSEHOLDS <span class="sc">|&gt;</span> <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(GEOID, year, households),</span>
<span id="cb24-594"><a href="#cb24-594" aria-hidden="true" tabindex="-1"></a>    <span class="fu">join_by</span>(<span class="st">"GEOID"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>, <span class="st">"year"</span> <span class="sc">==</span> <span class="st">"year"</span>)</span>
<span id="cb24-595"><a href="#cb24-595" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-596"><a href="#cb24-596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">household_size =</span> population <span class="sc">/</span> households) <span class="sc">|&gt;</span></span>
<span id="cb24-597"><a href="#cb24-597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb24-598"><a href="#cb24-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-599"><a href="#cb24-599" aria-hidden="true" tabindex="-1"></a>HH_SIZE <span class="ot">&lt;-</span> HH_SIZE <span class="sc">|&gt;</span></span>
<span id="cb24-600"><a href="#cb24-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">City =</span> <span class="fu">case_when</span>(</span>
<span id="cb24-601"><a href="#cb24-601" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(NAME, <span class="st">"^New York"</span>) <span class="sc">~</span> <span class="st">"New York"</span>,</span>
<span id="cb24-602"><a href="#cb24-602" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(NAME, <span class="st">"^Los Angeles"</span>) <span class="sc">~</span> <span class="st">"Los Angeles"</span>,</span>
<span id="cb24-603"><a href="#cb24-603" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">str_trim</span>(<span class="fu">str_split_fixed</span>(NAME, <span class="st">"–"</span>, <span class="dv">2</span>)[, <span class="dv">1</span>])</span>
<span id="cb24-604"><a href="#cb24-604" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb24-605"><a href="#cb24-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-606"><a href="#cb24-606" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(HH_SIZE, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> household_size, <span class="at">color =</span> City, <span class="at">group =</span> NAME)) <span class="sc">+</span></span>
<span id="cb24-607"><a href="#cb24-607" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb24-608"><a href="#cb24-608" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gghighlight</span>(</span>
<span id="cb24-609"><a href="#cb24-609" aria-hidden="true" tabindex="-1"></a>    City <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"New York"</span>, <span class="st">"Los Angeles"</span>),</span>
<span id="cb24-610"><a href="#cb24-610" aria-hidden="true" tabindex="-1"></a>    <span class="at">unhighlighted_params =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">"#b0c4de"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>),</span>
<span id="cb24-611"><a href="#cb24-611" aria-hidden="true" tabindex="-1"></a>    <span class="at">use_direct_label =</span> <span class="cn">TRUE</span>, <span class="at">label_key =</span> City</span>
<span id="cb24-612"><a href="#cb24-612" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-613"><a href="#cb24-613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb24-614"><a href="#cb24-614" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"New York"</span> <span class="ot">=</span> <span class="st">"#1f78b4"</span>,    </span>
<span id="cb24-615"><a href="#cb24-615" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Los Angeles"</span> <span class="ot">=</span> <span class="st">"#e31a1c"</span>) </span>
<span id="cb24-616"><a href="#cb24-616" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-617"><a href="#cb24-617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">number_format</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb24-618"><a href="#cb24-618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-619"><a href="#cb24-619" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Average Household Size Over Time — Highlighting NYC &amp; LA"</span>,</span>
<span id="cb24-620"><a href="#cb24-620" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"ACS 1-year estimates (CBSA 2009–2023)"</span>,</span>
<span id="cb24-621"><a href="#cb24-621" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb24-622"><a href="#cb24-622" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Household Size (persons per household)"</span></span>
<span id="cb24-623"><a href="#cb24-623" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-624"><a href="#cb24-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb24-625"><a href="#cb24-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb24-626"><a href="#cb24-626" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb24-627"><a href="#cb24-627" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb24-628"><a href="#cb24-628" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"#333333"</span>),</span>
<span id="cb24-629"><a href="#cb24-629" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"#333333"</span>)</span>
<span id="cb24-630"><a href="#cb24-630" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-631"><a href="#cb24-631" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-632"><a href="#cb24-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-633"><a href="#cb24-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-634"><a href="#cb24-634" aria-hidden="true" tabindex="-1"></a><span class="fu"># Task 4: Rent Burden</span></span>
<span id="cb24-635"><a href="#cb24-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-636"><a href="#cb24-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-637"><a href="#cb24-637" aria-hidden="true" tabindex="-1"></a><span class="fu">## </span></span>
<span id="cb24-638"><a href="#cb24-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-639"><a href="#cb24-639" aria-hidden="true" tabindex="-1"></a>This code calculates a rent-burden index and shows results in two tables.</span>
<span id="cb24-640"><a href="#cb24-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-641"><a href="#cb24-641" aria-hidden="true" tabindex="-1"></a>It first joins ACS income and rent data by CBSA and year, computing the rent-to-income ratio. The baseline year (first ACS year excluding 2020) is used to standardize values—setting the national average that year to 100. Each CBSA’s rent burden is then expressed relative to that baseline.</span>
<span id="cb24-642"><a href="#cb24-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-643"><a href="#cb24-643" aria-hidden="true" tabindex="-1"></a>For Q1, it displays the yearly rent burden for the New York–Newark–Jersey City metro area in an interactive table with currency and percentage formatting.</span>
<span id="cb24-644"><a href="#cb24-644" aria-hidden="true" tabindex="-1"></a>For Q2, it finds the CBSAs with the highest and lowest rent burden in the most recent year, presenting them side-by-side for quick comparison.</span>
<span id="cb24-645"><a href="#cb24-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-646"><a href="#cb24-646" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-647"><a href="#cb24-647" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-648"><a href="#cb24-648" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb24-649"><a href="#cb24-649" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb24-650"><a href="#cb24-650" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb24-651"><a href="#cb24-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-652"><a href="#cb24-652" aria-hidden="true" tabindex="-1"></a><span class="do">### Join INCOME + RENT and compute rent-to-income</span></span>
<span id="cb24-653"><a href="#cb24-653" aria-hidden="true" tabindex="-1"></a>rent_burden_raw <span class="ot">&lt;-</span> INCOME <span class="sc">|&gt;</span></span>
<span id="cb24-654"><a href="#cb24-654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(GEOID, year, household_income) <span class="sc">|&gt;</span></span>
<span id="cb24-655"><a href="#cb24-655" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(RENT <span class="sc">|&gt;</span> <span class="fu">select</span>(GEOID, year, monthly_rent),</span>
<span id="cb24-656"><a href="#cb24-656" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="st">"GEOID"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>, <span class="st">"year"</span> <span class="sc">==</span> <span class="st">"year"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-657"><a href="#cb24-657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rent_to_income =</span> monthly_rent <span class="sc">/</span> (household_income <span class="sc">/</span> <span class="dv">12</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-658"><a href="#cb24-658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(rent_to_income))</span>
<span id="cb24-659"><a href="#cb24-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-660"><a href="#cb24-660" aria-hidden="true" tabindex="-1"></a><span class="do">### Standardization: Baseline = 2009 national average (excluding 2020)</span></span>
<span id="cb24-661"><a href="#cb24-661" aria-hidden="true" tabindex="-1"></a>baseline_year <span class="ot">&lt;-</span> rent_burden_raw <span class="sc">|&gt;</span></span>
<span id="cb24-662"><a href="#cb24-662" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-663"><a href="#cb24-663" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">min_year =</span> <span class="fu">min</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-664"><a href="#cb24-664" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(min_year)</span>
<span id="cb24-665"><a href="#cb24-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-666"><a href="#cb24-666" aria-hidden="true" tabindex="-1"></a>baseline_ratio <span class="ot">&lt;-</span> rent_burden_raw <span class="sc">|&gt;</span></span>
<span id="cb24-667"><a href="#cb24-667" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> baseline_year) <span class="sc">|&gt;</span></span>
<span id="cb24-668"><a href="#cb24-668" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">b =</span> <span class="fu">mean</span>(rent_to_income, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-669"><a href="#cb24-669" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(b)</span>
<span id="cb24-670"><a href="#cb24-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-671"><a href="#cb24-671" aria-hidden="true" tabindex="-1"></a><span class="do">### Scaling: Normalize relative to the baseline year (set baseline = 100)</span></span>
<span id="cb24-672"><a href="#cb24-672" aria-hidden="true" tabindex="-1"></a>rent_burden_idx <span class="ot">&lt;-</span> rent_burden_raw <span class="sc">|&gt;</span></span>
<span id="cb24-673"><a href="#cb24-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rent_burden_index =</span> <span class="dv">100</span> <span class="sc">*</span> rent_to_income <span class="sc">/</span> baseline_ratio)</span>
<span id="cb24-674"><a href="#cb24-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-675"><a href="#cb24-675" aria-hidden="true" tabindex="-1"></a><span class="do">### Tables with DT</span></span>
<span id="cb24-676"><a href="#cb24-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-677"><a href="#cb24-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-678"><a href="#cb24-678" aria-hidden="true" tabindex="-1"></a><span class="do">## (Q1) Pick a single Metropolitan Area and see how rent burden has changed over time</span></span>
<span id="cb24-679"><a href="#cb24-679" aria-hidden="true" tabindex="-1"></a><span class="do">## In 2009, the New York–Newark–Jersey City area’s rent burden was about 10% above the national average, showing already high housing costs.</span></span>
<span id="cb24-680"><a href="#cb24-680" aria-hidden="true" tabindex="-1"></a><span class="do">## By 2023, the index rose to 114.6, about 4% higher than 2009, meaning rent grew slightly faster than income but the burden increase was modest overall.</span></span>
<span id="cb24-681"><a href="#cb24-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-682"><a href="#cb24-682" aria-hidden="true" tabindex="-1"></a>target_cbsa <span class="ot">&lt;-</span> <span class="st">"New York-Newark-Jersey City, NY-NJ-PA Metro Area"</span></span>
<span id="cb24-683"><a href="#cb24-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-684"><a href="#cb24-684" aria-hidden="true" tabindex="-1"></a>table_one <span class="ot">&lt;-</span> rent_burden_idx <span class="sc">|&gt;</span></span>
<span id="cb24-685"><a href="#cb24-685" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(POPULATION <span class="sc">|&gt;</span> <span class="fu">distinct</span>(GEOID, NAME),</span>
<span id="cb24-686"><a href="#cb24-686" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="st">"GEOID"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-687"><a href="#cb24-687" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(NAME <span class="sc">==</span> target_cbsa) <span class="sc">|&gt;</span></span>
<span id="cb24-688"><a href="#cb24-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb24-689"><a href="#cb24-689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, monthly_rent, household_income, rent_to_income, rent_burden_index)</span>
<span id="cb24-690"><a href="#cb24-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-691"><a href="#cb24-691" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(table_one, <span class="at">rownames =</span> <span class="cn">FALSE</span>,</span>
<span id="cb24-692"><a href="#cb24-692" aria-hidden="true" tabindex="-1"></a>          <span class="at">caption =</span> htmltools<span class="sc">::</span>tags<span class="sc">$</span><span class="fu">caption</span>(</span>
<span id="cb24-693"><a href="#cb24-693" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">"Rent Burden Over Time — "</span>, target_cbsa,</span>
<span id="cb24-694"><a href="#cb24-694" aria-hidden="true" tabindex="-1"></a>                   <span class="st">" (Baseline Year = "</span>, baseline_year, <span class="st">")"</span>)),</span>
<span id="cb24-695"><a href="#cb24-695" aria-hidden="true" tabindex="-1"></a>          <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">20</span>, <span class="at">dom =</span> <span class="st">"tip"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-696"><a href="#cb24-696" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatCurrency</span>(<span class="st">"monthly_rent"</span>, <span class="at">currency =</span> <span class="st">"$"</span>, <span class="at">digits =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-697"><a href="#cb24-697" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatCurrency</span>(<span class="st">"household_income"</span>, <span class="at">currency =</span> <span class="st">"$"</span>, <span class="at">digits =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-698"><a href="#cb24-698" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatPercentage</span>(<span class="st">"rent_to_income"</span>, <span class="at">digits =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-699"><a href="#cb24-699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(<span class="st">"rent_burden_index"</span>, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb24-700"><a href="#cb24-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-701"><a href="#cb24-701" aria-hidden="true" tabindex="-1"></a><span class="do">## (Q2) Highlight the Metro Areas highest and lowest with the highest and lowest rent burden</span></span>
<span id="cb24-702"><a href="#cb24-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-703"><a href="#cb24-703" aria-hidden="true" tabindex="-1"></a>latest_year <span class="ot">&lt;-</span> rent_burden_idx <span class="sc">|&gt;</span></span>
<span id="cb24-704"><a href="#cb24-704" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-705"><a href="#cb24-705" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">latest =</span> <span class="fu">max</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-706"><a href="#cb24-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(latest)</span>
<span id="cb24-707"><a href="#cb24-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-708"><a href="#cb24-708" aria-hidden="true" tabindex="-1"></a>hi_lo <span class="ot">&lt;-</span> rent_burden_idx <span class="sc">|&gt;</span></span>
<span id="cb24-709"><a href="#cb24-709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> latest_year) <span class="sc">|&gt;</span></span>
<span id="cb24-710"><a href="#cb24-710" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(POPULATION <span class="sc">|&gt;</span> <span class="fu">distinct</span>(GEOID, NAME),</span>
<span id="cb24-711"><a href="#cb24-711" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="st">"GEOID"</span> <span class="sc">==</span> <span class="st">"GEOID"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-712"><a href="#cb24-712" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(NAME, year, rent_to_income, rent_burden_index)</span>
<span id="cb24-713"><a href="#cb24-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-714"><a href="#cb24-714" aria-hidden="true" tabindex="-1"></a>highest_row <span class="ot">&lt;-</span> hi_lo <span class="sc">|&gt;</span></span>
<span id="cb24-715"><a href="#cb24-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(rent_burden_index), <span class="fu">desc</span>(rent_to_income), NAME) <span class="sc">|&gt;</span></span>
<span id="cb24-716"><a href="#cb24-716" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-717"><a href="#cb24-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"Highest"</span>)</span>
<span id="cb24-718"><a href="#cb24-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-719"><a href="#cb24-719" aria-hidden="true" tabindex="-1"></a>lowest_row <span class="ot">&lt;-</span> hi_lo <span class="sc">|&gt;</span></span>
<span id="cb24-720"><a href="#cb24-720" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(rent_burden_index, rent_to_income, NAME) <span class="sc">|&gt;</span></span>
<span id="cb24-721"><a href="#cb24-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-722"><a href="#cb24-722" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"Lowest"</span>)</span>
<span id="cb24-723"><a href="#cb24-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-724"><a href="#cb24-724" aria-hidden="true" tabindex="-1"></a>table_two <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(highest_row, lowest_row) <span class="sc">|&gt;</span></span>
<span id="cb24-725"><a href="#cb24-725" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="fu">factor</span>(Group, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Highest"</span>, <span class="st">"Lowest"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb24-726"><a href="#cb24-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Group)</span>
<span id="cb24-727"><a href="#cb24-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-728"><a href="#cb24-728" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(</span>
<span id="cb24-729"><a href="#cb24-729" aria-hidden="true" tabindex="-1"></a>  table_two, </span>
<span id="cb24-730"><a href="#cb24-730" aria-hidden="true" tabindex="-1"></a>  <span class="at">rownames =</span> <span class="cn">FALSE</span>,</span>
<span id="cb24-731"><a href="#cb24-731" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> htmltools<span class="sc">::</span>tags<span class="sc">$</span><span class="fu">caption</span>(</span>
<span id="cb24-732"><a href="#cb24-732" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="st">'caption-side: top; text-align: left; font-weight: bold; font-size: 16px;'</span>,</span>
<span id="cb24-733"><a href="#cb24-733" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"Highest &amp; Lowest Metro Areas by Rent Burden — "</span>, latest_year)</span>
<span id="cb24-734"><a href="#cb24-734" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb24-735"><a href="#cb24-735" aria-hidden="true" tabindex="-1"></a>  <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">2</span>, <span class="at">dom =</span> <span class="st">"t"</span>)</span>
<span id="cb24-736"><a href="#cb24-736" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb24-737"><a href="#cb24-737" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatPercentage</span>(<span class="st">"rent_to_income"</span>, <span class="at">digits =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-738"><a href="#cb24-738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(<span class="st">"rent_burden_index"</span>, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb24-739"><a href="#cb24-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-740"><a href="#cb24-740" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-741"><a href="#cb24-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-742"><a href="#cb24-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-743"><a href="#cb24-743" aria-hidden="true" tabindex="-1"></a><span class="fu"># Task 5: Housing Growth</span></span>
<span id="cb24-744"><a href="#cb24-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-745"><a href="#cb24-745" aria-hidden="true" tabindex="-1"></a>##</span>
<span id="cb24-746"><a href="#cb24-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-747"><a href="#cb24-747" aria-hidden="true" tabindex="-1"></a>This code measures housing growth across CBSAs and identifies which cities are more “building-friendly.”</span>
<span id="cb24-748"><a href="#cb24-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-749"><a href="#cb24-749" aria-hidden="true" tabindex="-1"></a>It joins population and building permit data, calculates 5-year population growth, and removes missing or zero values. Two indicators are then computed:</span>
<span id="cb24-750"><a href="#cb24-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-751"><a href="#cb24-751" aria-hidden="true" tabindex="-1"></a>Instant growth: permits per person.</span>
<span id="cb24-752"><a href="#cb24-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-753"><a href="#cb24-753" aria-hidden="true" tabindex="-1"></a>Rate growth: permits per 5-year population change.</span>
<span id="cb24-754"><a href="#cb24-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-755"><a href="#cb24-755" aria-hidden="true" tabindex="-1"></a>Both are standardized (z-scores) and summed into a composite score, where higher values mean faster housing expansion.</span>
<span id="cb24-756"><a href="#cb24-756" aria-hidden="true" tabindex="-1"></a>Finally, it lists the top 10 and bottom 10 CBSAs for the most recent year in an interactive table.</span>
<span id="cb24-757"><a href="#cb24-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-758"><a href="#cb24-758" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-759"><a href="#cb24-759" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-760"><a href="#cb24-760" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb24-761"><a href="#cb24-761" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RcppRoll)</span>
<span id="cb24-762"><a href="#cb24-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-763"><a href="#cb24-763" aria-hidden="true" tabindex="-1"></a><span class="do">## Join POPULATION and PERMITS tables</span></span>
<span id="cb24-764"><a href="#cb24-764" aria-hidden="true" tabindex="-1"></a>housing_raw <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb24-765"><a href="#cb24-765" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GEOID =</span> <span class="fu">as.integer</span>(GEOID)) <span class="sc">|&gt;</span></span>
<span id="cb24-766"><a href="#cb24-766" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(GEOID, NAME, year, population) <span class="sc">|&gt;</span></span>
<span id="cb24-767"><a href="#cb24-767" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb24-768"><a href="#cb24-768" aria-hidden="true" tabindex="-1"></a>    PERMITS <span class="sc">|&gt;</span> <span class="fu">select</span>(CBSA, year, new_housing_units_permitted),</span>
<span id="cb24-769"><a href="#cb24-769" aria-hidden="true" tabindex="-1"></a>    <span class="fu">join_by</span>(GEOID <span class="sc">==</span> CBSA, year <span class="sc">==</span> year)</span>
<span id="cb24-770"><a href="#cb24-770" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-771"><a href="#cb24-771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">permits =</span> new_housing_units_permitted) <span class="sc">|&gt;</span></span>
<span id="cb24-772"><a href="#cb24-772" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(GEOID, year)</span>
<span id="cb24-773"><a href="#cb24-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-774"><a href="#cb24-774" aria-hidden="true" tabindex="-1"></a><span class="do">## Compute 5-year population growth</span></span>
<span id="cb24-775"><a href="#cb24-775" aria-hidden="true" tabindex="-1"></a>housing_raw <span class="ot">&lt;-</span> housing_raw <span class="sc">|&gt;</span></span>
<span id="cb24-776"><a href="#cb24-776" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID) <span class="sc">|&gt;</span></span>
<span id="cb24-777"><a href="#cb24-777" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pop_growth_5yr =</span> population <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(population, <span class="dv">5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-778"><a href="#cb24-778" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb24-779"><a href="#cb24-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-780"><a href="#cb24-780" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Apply a 5-year rolling average to smooth noisy data</span></span>
<span id="cb24-781"><a href="#cb24-781" aria-hidden="true" tabindex="-1"></a>housing_smoothed <span class="ot">&lt;-</span> housing_raw <span class="sc">|&gt;</span></span>
<span id="cb24-782"><a href="#cb24-782" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID) <span class="sc">|&gt;</span></span>
<span id="cb24-783"><a href="#cb24-783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-784"><a href="#cb24-784" aria-hidden="true" tabindex="-1"></a>    <span class="at">permits_5yr_avg    =</span> RcppRoll<span class="sc">::</span><span class="fu">roll_meanr</span>(permits,    <span class="at">n =</span> <span class="dv">5</span>, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb24-785"><a href="#cb24-785" aria-hidden="true" tabindex="-1"></a>    <span class="at">population_5yr_avg =</span> RcppRoll<span class="sc">::</span><span class="fu">roll_meanr</span>(population, <span class="at">n =</span> <span class="dv">5</span>, <span class="at">fill =</span> <span class="cn">NA</span>)</span>
<span id="cb24-786"><a href="#cb24-786" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-787"><a href="#cb24-787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb24-788"><a href="#cb24-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-789"><a href="#cb24-789" aria-hidden="true" tabindex="-1"></a><span class="do">## Remove invalid observations (NA or zero values)</span></span>
<span id="cb24-790"><a href="#cb24-790" aria-hidden="true" tabindex="-1"></a>housing_growth <span class="ot">&lt;-</span> housing_smoothed <span class="sc">|&gt;</span></span>
<span id="cb24-791"><a href="#cb24-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(pop_growth_5yr), pop_growth_5yr <span class="sc">!=</span> <span class="dv">0</span>,</span>
<span id="cb24-792"><a href="#cb24-792" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(permits), permits <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb24-793"><a href="#cb24-793" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(population), population <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-794"><a href="#cb24-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-795"><a href="#cb24-795" aria-hidden="true" tabindex="-1"></a><span class="do">## Instantaneous metric: permits per person </span></span>
<span id="cb24-796"><a href="#cb24-796" aria-hidden="true" tabindex="-1"></a><span class="do">## Rate-based metric: permits per 5-year population change</span></span>
<span id="cb24-797"><a href="#cb24-797" aria-hidden="true" tabindex="-1"></a><span class="do">## (negative values indicate construction slower than population loss) </span></span>
<span id="cb24-798"><a href="#cb24-798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-799"><a href="#cb24-799" aria-hidden="true" tabindex="-1"></a>    <span class="at">instant_growth =</span> permits <span class="sc">/</span> population,</span>
<span id="cb24-800"><a href="#cb24-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-801"><a href="#cb24-801" aria-hidden="true" tabindex="-1"></a>    <span class="at">rate_growth =</span> permits <span class="sc">/</span> pop_growth_5yr</span>
<span id="cb24-802"><a href="#cb24-802" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-803"><a href="#cb24-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-804"><a href="#cb24-804" aria-hidden="true" tabindex="-1"></a><span class="do">## Standardize metrics (Z-scores) and create a composite index</span></span>
<span id="cb24-805"><a href="#cb24-805" aria-hidden="true" tabindex="-1"></a><span class="do">## Z-scores normalize each metric (mean = 0, sd = 1)</span></span>
<span id="cb24-806"><a href="#cb24-806" aria-hidden="true" tabindex="-1"></a><span class="do">## Composite score C = Z_instant + Z_rate</span></span>
<span id="cb24-807"><a href="#cb24-807" aria-hidden="true" tabindex="-1"></a><span class="do">## &gt;0 means "Building-Friendly", &lt;0 means "Not Friendly"</span></span>
<span id="cb24-808"><a href="#cb24-808" aria-hidden="true" tabindex="-1"></a>housing_growth <span class="ot">&lt;-</span> housing_growth <span class="sc">|&gt;</span></span>
<span id="cb24-809"><a href="#cb24-809" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-810"><a href="#cb24-810" aria-hidden="true" tabindex="-1"></a>    <span class="at">z_instant =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(instant_growth)),</span>
<span id="cb24-811"><a href="#cb24-811" aria-hidden="true" tabindex="-1"></a>    <span class="at">z_rate    =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(rate_growth)),</span>
<span id="cb24-812"><a href="#cb24-812" aria-hidden="true" tabindex="-1"></a>    <span class="at">composite_score =</span> z_instant <span class="sc">+</span> z_rate,</span>
<span id="cb24-813"><a href="#cb24-813" aria-hidden="true" tabindex="-1"></a>    <span class="at">friendly_flag   =</span> <span class="fu">if_else</span>(composite_score <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Building-Friendly"</span>, <span class="st">"Not Friendly"</span>)</span>
<span id="cb24-814"><a href="#cb24-814" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-815"><a href="#cb24-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-816"><a href="#cb24-816" aria-hidden="true" tabindex="-1"></a><span class="do">## Identify top and bottom CBSAs for the most recent year</span></span>
<span id="cb24-817"><a href="#cb24-817" aria-hidden="true" tabindex="-1"></a>latest_year <span class="ot">&lt;-</span> housing_growth <span class="sc">|&gt;</span></span>
<span id="cb24-818"><a href="#cb24-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">max</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-819"><a href="#cb24-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>()</span>
<span id="cb24-820"><a href="#cb24-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-821"><a href="#cb24-821" aria-hidden="true" tabindex="-1"></a>table_latest <span class="ot">&lt;-</span> housing_growth <span class="sc">|&gt;</span></span>
<span id="cb24-822"><a href="#cb24-822" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> latest_year) <span class="sc">|&gt;</span></span>
<span id="cb24-823"><a href="#cb24-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(NAME, year, instant_growth, rate_growth, composite_score, friendly_flag) <span class="sc">|&gt;</span></span>
<span id="cb24-824"><a href="#cb24-824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(composite_score))</span>
<span id="cb24-825"><a href="#cb24-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-826"><a href="#cb24-826" aria-hidden="true" tabindex="-1"></a><span class="do">## Create summary tables (Top 10 / Bottom 10)</span></span>
<span id="cb24-827"><a href="#cb24-827" aria-hidden="true" tabindex="-1"></a>table_top_bottom <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb24-828"><a href="#cb24-828" aria-hidden="true" tabindex="-1"></a>  table_latest <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"Highest"</span>),</span>
<span id="cb24-829"><a href="#cb24-829" aria-hidden="true" tabindex="-1"></a>  table_latest <span class="sc">|&gt;</span> <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">Group =</span> <span class="st">"Lowest"</span>)</span>
<span id="cb24-830"><a href="#cb24-830" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb24-831"><a href="#cb24-831" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Group), <span class="fu">desc</span>(composite_score))</span>
<span id="cb24-832"><a href="#cb24-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-833"><a href="#cb24-833" aria-hidden="true" tabindex="-1"></a><span class="do">## Display interactive table (DT)</span></span>
<span id="cb24-834"><a href="#cb24-834" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(</span>
<span id="cb24-835"><a href="#cb24-835" aria-hidden="true" tabindex="-1"></a>  table_top_bottom,</span>
<span id="cb24-836"><a href="#cb24-836" aria-hidden="true" tabindex="-1"></a>  <span class="at">rownames =</span> <span class="cn">FALSE</span>,</span>
<span id="cb24-837"><a href="#cb24-837" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> htmltools<span class="sc">::</span>tags<span class="sc">$</span><span class="fu">caption</span>(</span>
<span id="cb24-838"><a href="#cb24-838" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="st">'caption-side: top; text-align: left; font-weight: bold; font-size: 16px;'</span>,</span>
<span id="cb24-839"><a href="#cb24-839" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"Top &amp; Bottom CBSAs by Building-Friendliness — "</span>, latest_year,</span>
<span id="cb24-840"><a href="#cb24-840" aria-hidden="true" tabindex="-1"></a>           <span class="st">" (Zeros/NA excluded)"</span>)</span>
<span id="cb24-841"><a href="#cb24-841" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb24-842"><a href="#cb24-842" aria-hidden="true" tabindex="-1"></a>  <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">20</span>, <span class="at">dom =</span> <span class="st">"tip"</span>)</span>
<span id="cb24-843"><a href="#cb24-843" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb24-844"><a href="#cb24-844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatRound</span>(<span class="fu">c</span>(<span class="st">"instant_growth"</span>, <span class="st">"rate_growth"</span>, <span class="st">"composite_score"</span>), <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb24-845"><a href="#cb24-845" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-846"><a href="#cb24-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-847"><a href="#cb24-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-848"><a href="#cb24-848" aria-hidden="true" tabindex="-1"></a><span class="fu"># Task 6: Visualization</span></span>
<span id="cb24-849"><a href="#cb24-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-850"><a href="#cb24-850" aria-hidden="true" tabindex="-1"></a>This code visualizes how housing growth and rent burden interact across U.S. metro areas.</span>
<span id="cb24-851"><a href="#cb24-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-852"><a href="#cb24-852" aria-hidden="true" tabindex="-1"></a>The first plot compares each CBSA’s change in rent burden (x-axis) and average housing growth (y-axis), with bubble size showing population growth. Cities in the upper-left quadrant built housing fast enough to reduce rent burden—potential “YIMBY success stories.”</span>
<span id="cb24-853"><a href="#cb24-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-854"><a href="#cb24-854" aria-hidden="true" tabindex="-1"></a>The second plot aggregates these results by state, ranking the Top 10 YIMBY-oriented states using a composite score that combines rent burden reduction, housing growth, and population growth.</span>
<span id="cb24-855"><a href="#cb24-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-856"><a href="#cb24-856" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, message=FALSE, warning=FALSE}</span></span>
<span id="cb24-857"><a href="#cb24-857" aria-hidden="true" tabindex="-1"></a><span class="do">## Visualization 1 -----------------------------------------</span></span>
<span id="cb24-858"><a href="#cb24-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-859"><a href="#cb24-859" aria-hidden="true" tabindex="-1"></a><span class="do">## The plot shows that CBSAs in the upper-left region—particularly several smaller metros like Salisbury and Hammond—</span></span>
<span id="cb24-860"><a href="#cb24-860" aria-hidden="true" tabindex="-1"></a><span class="do">## built housing rapidly enough that rent burdens fell despite population growth, illustrating potential “YIMBY success stories.”</span></span>
<span id="cb24-861"><a href="#cb24-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-862"><a href="#cb24-862" aria-hidden="true" tabindex="-1"></a><span class="do">## Tables</span></span>
<span id="cb24-863"><a href="#cb24-863" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-864"><a href="#cb24-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-865"><a href="#cb24-865" aria-hidden="true" tabindex="-1"></a><span class="do">## Define early and late periods</span></span>
<span id="cb24-866"><a href="#cb24-866" aria-hidden="true" tabindex="-1"></a>early_years <span class="ot">&lt;-</span> <span class="dv">2009</span><span class="sc">:</span><span class="dv">2012</span></span>
<span id="cb24-867"><a href="#cb24-867" aria-hidden="true" tabindex="-1"></a>late_years  <span class="ot">&lt;-</span> <span class="dv">2021</span><span class="sc">:</span><span class="dv">2023</span></span>
<span id="cb24-868"><a href="#cb24-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-869"><a href="#cb24-869" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract unique CBSA names</span></span>
<span id="cb24-870"><a href="#cb24-870" aria-hidden="true" tabindex="-1"></a>cbsa_names <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span> <span class="fu">distinct</span>(GEOID, NAME)</span>
<span id="cb24-871"><a href="#cb24-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-872"><a href="#cb24-872" aria-hidden="true" tabindex="-1"></a><span class="do">## Rent Burden Summary</span></span>
<span id="cb24-873"><a href="#cb24-873" aria-hidden="true" tabindex="-1"></a>rb_summary <span class="ot">&lt;-</span> rent_burden_idx <span class="sc">|&gt;</span></span>
<span id="cb24-874"><a href="#cb24-874" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-875"><a href="#cb24-875" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID) <span class="sc">|&gt;</span></span>
<span id="cb24-876"><a href="#cb24-876" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb24-877"><a href="#cb24-877" aria-hidden="true" tabindex="-1"></a>    <span class="at">rb_early =</span> <span class="fu">mean</span>(rent_burden_index[year <span class="sc">%in%</span> early_years], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-878"><a href="#cb24-878" aria-hidden="true" tabindex="-1"></a>    <span class="at">rb_late  =</span> <span class="fu">mean</span>(rent_burden_index[year <span class="sc">%in%</span> late_years],  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-879"><a href="#cb24-879" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb24-880"><a href="#cb24-880" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-881"><a href="#cb24-881" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-882"><a href="#cb24-882" aria-hidden="true" tabindex="-1"></a>    <span class="at">rb_delta =</span> rb_late <span class="sc">-</span> rb_early</span>
<span id="cb24-883"><a href="#cb24-883" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-884"><a href="#cb24-884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(rb_early), <span class="fu">is.finite</span>(rb_late), <span class="fu">is.finite</span>(rb_delta))</span>
<span id="cb24-885"><a href="#cb24-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-886"><a href="#cb24-886" aria-hidden="true" tabindex="-1"></a><span class="do">## Population Summary</span></span>
<span id="cb24-887"><a href="#cb24-887" aria-hidden="true" tabindex="-1"></a>pop_summary <span class="ot">&lt;-</span> POPULATION <span class="sc">|&gt;</span></span>
<span id="cb24-888"><a href="#cb24-888" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">!=</span> <span class="dv">2020</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-889"><a href="#cb24-889" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID) <span class="sc">|&gt;</span></span>
<span id="cb24-890"><a href="#cb24-890" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb24-891"><a href="#cb24-891" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_first_year =</span> <span class="fu">min</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-892"><a href="#cb24-892" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_last_year  =</span> <span class="fu">max</span>(year, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-893"><a href="#cb24-893" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_start =</span> <span class="fu">first</span>(population[year <span class="sc">==</span> pop_first_year]),</span>
<span id="cb24-894"><a href="#cb24-894" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_end   =</span> <span class="fu">first</span>(population[year <span class="sc">==</span> pop_last_year]),</span>
<span id="cb24-895"><a href="#cb24-895" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb24-896"><a href="#cb24-896" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-897"><a href="#cb24-897" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-898"><a href="#cb24-898" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_change_abs =</span> pop_end <span class="sc">-</span> pop_start,</span>
<span id="cb24-899"><a href="#cb24-899" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_change_pct =</span> <span class="fu">ifelse</span>(pop_start <span class="sc">&gt;</span> <span class="dv">0</span>, (pop_end <span class="sc">-</span> pop_start)<span class="sc">/</span>pop_start, <span class="cn">NA_real_</span>)</span>
<span id="cb24-900"><a href="#cb24-900" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-901"><a href="#cb24-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-902"><a href="#cb24-902" aria-hidden="true" tabindex="-1"></a><span class="do">## Housing Growth Summary</span></span>
<span id="cb24-903"><a href="#cb24-903" aria-hidden="true" tabindex="-1"></a>hg_summary <span class="ot">&lt;-</span> housing_growth <span class="sc">|&gt;</span></span>
<span id="cb24-904"><a href="#cb24-904" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;=</span> <span class="dv">2014</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-905"><a href="#cb24-905" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(GEOID) <span class="sc">|&gt;</span></span>
<span id="cb24-906"><a href="#cb24-906" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">hg_avg =</span> <span class="fu">mean</span>(composite_score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-907"><a href="#cb24-907" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(hg_avg))</span>
<span id="cb24-908"><a href="#cb24-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-909"><a href="#cb24-909" aria-hidden="true" tabindex="-1"></a><span class="do">## Combine and Clean Up</span></span>
<span id="cb24-910"><a href="#cb24-910" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb24-911"><a href="#cb24-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-912"><a href="#cb24-912" aria-hidden="true" tabindex="-1"></a>summary_cbsa <span class="ot">&lt;-</span> rb_summary <span class="sc">|&gt;</span></span>
<span id="cb24-913"><a href="#cb24-913" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(pop_summary, <span class="at">by =</span> <span class="st">"GEOID"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-914"><a href="#cb24-914" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(hg_summary,  <span class="at">by =</span> <span class="st">"GEOID"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-915"><a href="#cb24-915" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(cbsa_names,  <span class="at">by =</span> <span class="st">"GEOID"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-916"><a href="#cb24-916" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(rb_delta), <span class="fu">is.finite</span>(hg_avg)) <span class="sc">|&gt;</span></span>
<span id="cb24-917"><a href="#cb24-917" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-918"><a href="#cb24-918" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flag CBSAs with early rent burden in top 25%</span></span>
<span id="cb24-919"><a href="#cb24-919" aria-hidden="true" tabindex="-1"></a>    <span class="at">early_high_flag =</span> rb_early <span class="sc">&gt;=</span> <span class="fu">quantile</span>(rb_early, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-920"><a href="#cb24-920" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean population growth percentage (non-negative)</span></span>
<span id="cb24-921"><a href="#cb24-921" aria-hidden="true" tabindex="-1"></a>    <span class="at">size_var =</span> <span class="fu">pmax</span>(<span class="dv">0</span>, pop_change_pct),</span>
<span id="cb24-922"><a href="#cb24-922" aria-hidden="true" tabindex="-1"></a>    <span class="at">size_var =</span> <span class="fu">replace_na</span>(size_var, <span class="dv">0</span>)</span>
<span id="cb24-923"><a href="#cb24-923" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-924"><a href="#cb24-924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(size_var))</span>
<span id="cb24-925"><a href="#cb24-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-926"><a href="#cb24-926" aria-hidden="true" tabindex="-1"></a><span class="do">## National mean of housing growth (for reference line)</span></span>
<span id="cb24-927"><a href="#cb24-927" aria-hidden="true" tabindex="-1"></a>hg_mean_all <span class="ot">&lt;-</span> <span class="fu">mean</span>(summary_cbsa<span class="sc">$</span>hg_avg, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-928"><a href="#cb24-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-929"><a href="#cb24-929" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot with Safety Checks</span></span>
<span id="cb24-930"><a href="#cb24-930" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb24-931"><a href="#cb24-931" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb24-932"><a href="#cb24-932" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb24-933"><a href="#cb24-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-934"><a href="#cb24-934" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> summary_cbsa <span class="sc">|&gt;</span></span>
<span id="cb24-935"><a href="#cb24-935" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rb_delta, <span class="at">y =</span> hg_avg)) <span class="sc">+</span></span>
<span id="cb24-936"><a href="#cb24-936" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reference lines</span></span>
<span id="cb24-937"><a href="#cb24-937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> hg_mean_all, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb24-938"><a href="#cb24-938" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb24-939"><a href="#cb24-939" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scatter points</span></span>
<span id="cb24-940"><a href="#cb24-940" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb24-941"><a href="#cb24-941" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">size =</span> size_var, <span class="at">color =</span> early_high_flag),</span>
<span id="cb24-942"><a href="#cb24-942" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.75</span>,</span>
<span id="cb24-943"><a href="#cb24-943" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb24-944"><a href="#cb24-944" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-945"><a href="#cb24-945" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Color and size scales</span></span>
<span id="cb24-946"><a href="#cb24-946" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb24-947"><a href="#cb24-947" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"#d62728"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"#8da0cb"</span>),</span>
<span id="cb24-948"><a href="#cb24-948" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"High Early Rent Burden"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"Others"</span>),</span>
<span id="cb24-949"><a href="#cb24-949" aria-hidden="true" tabindex="-1"></a>    <span class="at">name   =</span> <span class="st">"Early Rent Burden"</span></span>
<span id="cb24-950"><a href="#cb24-950" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-951"><a href="#cb24-951" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(</span>
<span id="cb24-952"><a href="#cb24-952" aria-hidden="true" tabindex="-1"></a>    <span class="at">range =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="dv">9</span>),</span>
<span id="cb24-953"><a href="#cb24-953" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(summary_cbsa<span class="sc">$</span>size_var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb24-954"><a href="#cb24-954" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>),</span>
<span id="cb24-955"><a href="#cb24-955" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Population Growth (%)"</span></span>
<span id="cb24-956"><a href="#cb24-956" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-957"><a href="#cb24-957" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Titles and labels</span></span>
<span id="cb24-958"><a href="#cb24-958" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-959"><a href="#cb24-959" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"YIMBY Quadrant — Rent Burden Change vs Housing Growth"</span>,</span>
<span id="cb24-960"><a href="#cb24-960" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Left = Rent burden ↓ ; Up = Housing growth ↑ ; Size = Population growth"</span>,</span>
<span id="cb24-961"><a href="#cb24-961" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Change in Rent Burden Index (Late − Early) → lower is better"</span>,</span>
<span id="cb24-962"><a href="#cb24-962" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Housing Growth (Composite Score)"</span></span>
<span id="cb24-963"><a href="#cb24-963" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-964"><a href="#cb24-964" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>)</span>
<span id="cb24-965"><a href="#cb24-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-966"><a href="#cb24-966" aria-hidden="true" tabindex="-1"></a>p1</span>
<span id="cb24-967"><a href="#cb24-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-968"><a href="#cb24-968" aria-hidden="true" tabindex="-1"></a><span class="do">## Add Labels (Optional, without ggrepel)</span></span>
<span id="cb24-969"><a href="#cb24-969" aria-hidden="true" tabindex="-1"></a>yimby_candidates <span class="ot">&lt;-</span> summary_cbsa <span class="sc">|&gt;</span></span>
<span id="cb24-970"><a href="#cb24-970" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(early_high_flag, rb_delta <span class="sc">&lt;</span> <span class="dv">0</span>, pop_change_abs <span class="sc">&gt;</span> <span class="dv">0</span>, hg_avg <span class="sc">&gt;</span> hg_mean_all)</span>
<span id="cb24-971"><a href="#cb24-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-972"><a href="#cb24-972" aria-hidden="true" tabindex="-1"></a>top_labels <span class="ot">&lt;-</span> yimby_candidates <span class="sc">|&gt;</span></span>
<span id="cb24-973"><a href="#cb24-973" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(rb_delta, <span class="fu">desc</span>(hg_avg), <span class="fu">desc</span>(pop_change_abs)) <span class="sc">|&gt;</span></span>
<span id="cb24-974"><a href="#cb24-974" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb24-975"><a href="#cb24-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-976"><a href="#cb24-976" aria-hidden="true" tabindex="-1"></a>p1_labels <span class="ot">&lt;-</span> p1 <span class="sc">+</span></span>
<span id="cb24-977"><a href="#cb24-977" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb24-978"><a href="#cb24-978" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> top_labels,</span>
<span id="cb24-979"><a href="#cb24-979" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">str_remove</span>(NAME, <span class="st">" Metro Area$"</span>)),</span>
<span id="cb24-980"><a href="#cb24-980" aria-hidden="true" tabindex="-1"></a>    <span class="at">check_overlap =</span> <span class="cn">TRUE</span>,</span>
<span id="cb24-981"><a href="#cb24-981" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="fu">position_nudge</span>(<span class="at">x =</span> <span class="sc">-</span><span class="fl">0.02</span>, <span class="at">y =</span> <span class="fl">0.02</span>),</span>
<span id="cb24-982"><a href="#cb24-982" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">3.2</span>,</span>
<span id="cb24-983"><a href="#cb24-983" aria-hidden="true" tabindex="-1"></a>    <span class="at">fontface =</span> <span class="st">"bold"</span>,</span>
<span id="cb24-984"><a href="#cb24-984" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb24-985"><a href="#cb24-985" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-986"><a href="#cb24-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-987"><a href="#cb24-987" aria-hidden="true" tabindex="-1"></a>p1_labels</span>
<span id="cb24-988"><a href="#cb24-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-989"><a href="#cb24-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-990"><a href="#cb24-990" aria-hidden="true" tabindex="-1"></a><span class="do">## Visualization 2 -------------------------------------------------------------</span></span>
<span id="cb24-991"><a href="#cb24-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-992"><a href="#cb24-992" aria-hidden="true" tabindex="-1"></a><span class="do">## Top 10 YIMBY-Oriented States</span></span>
<span id="cb24-993"><a href="#cb24-993" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-994"><a href="#cb24-994" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb24-995"><a href="#cb24-995" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb24-996"><a href="#cb24-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-997"><a href="#cb24-997" aria-hidden="true" tabindex="-1"></a><span class="do">## Compute YIMBY composite score by CBSA</span></span>
<span id="cb24-998"><a href="#cb24-998" aria-hidden="true" tabindex="-1"></a>yimby_score <span class="ot">&lt;-</span> summary_cbsa <span class="sc">|&gt;</span></span>
<span id="cb24-999"><a href="#cb24-999" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-1000"><a href="#cb24-1000" aria-hidden="true" tabindex="-1"></a>    <span class="at">yimby_score =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(<span class="sc">-</span>rb_delta) <span class="sc">+</span> <span class="fu">scale</span>(hg_avg) <span class="sc">+</span> <span class="fu">scale</span>(size_var))</span>
<span id="cb24-1001"><a href="#cb24-1001" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-1002"><a href="#cb24-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1003"><a href="#cb24-1003" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract state abbreviation from NAME (e.g., ", FL" → "FL")</span></span>
<span id="cb24-1004"><a href="#cb24-1004" aria-hidden="true" tabindex="-1"></a>yimby_score <span class="ot">&lt;-</span> yimby_score <span class="sc">|&gt;</span></span>
<span id="cb24-1005"><a href="#cb24-1005" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-1006"><a href="#cb24-1006" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_extract</span>(NAME, <span class="st">"(?&lt;=, )[A-Z]{2}"</span>)</span>
<span id="cb24-1007"><a href="#cb24-1007" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-1008"><a href="#cb24-1008" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(state))</span>
<span id="cb24-1009"><a href="#cb24-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1010"><a href="#cb24-1010" aria-hidden="true" tabindex="-1"></a><span class="do">## Aggregate to state-level (mean score across CBSAs)</span></span>
<span id="cb24-1011"><a href="#cb24-1011" aria-hidden="true" tabindex="-1"></a>state_yimby <span class="ot">&lt;-</span> yimby_score <span class="sc">|&gt;</span></span>
<span id="cb24-1012"><a href="#cb24-1012" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state) <span class="sc">|&gt;</span></span>
<span id="cb24-1013"><a href="#cb24-1013" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb24-1014"><a href="#cb24-1014" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_yimby_score =</span> <span class="fu">mean</span>(yimby_score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-1015"><a href="#cb24-1015" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_burden_share =</span> <span class="fu">mean</span>(early_high_flag, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># share of high-burden CBSAs</span></span>
<span id="cb24-1016"><a href="#cb24-1016" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb24-1017"><a href="#cb24-1017" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-1018"><a href="#cb24-1018" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_yimby_score)) <span class="sc">|&gt;</span></span>
<span id="cb24-1019"><a href="#cb24-1019" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)  <span class="co"># 🔹 Top 10 States</span></span>
<span id="cb24-1020"><a href="#cb24-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1021"><a href="#cb24-1021" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot</span></span>
<span id="cb24-1022"><a href="#cb24-1022" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(state_yimby, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(state, avg_yimby_score),</span>
<span id="cb24-1023"><a href="#cb24-1023" aria-hidden="true" tabindex="-1"></a>                        <span class="at">y =</span> avg_yimby_score,</span>
<span id="cb24-1024"><a href="#cb24-1024" aria-hidden="true" tabindex="-1"></a>                        <span class="at">fill =</span> high_burden_share)) <span class="sc">+</span></span>
<span id="cb24-1025"><a href="#cb24-1025" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">alpha =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb24-1026"><a href="#cb24-1026" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb24-1027"><a href="#cb24-1027" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb24-1028"><a href="#cb24-1028" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">"#377eb8"</span>, <span class="at">high =</span> <span class="st">"#e31a1c"</span>,</span>
<span id="cb24-1029"><a href="#cb24-1029" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Share of High Early Rent Burden CBSAs"</span>,</span>
<span id="cb24-1030"><a href="#cb24-1030" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb24-1031"><a href="#cb24-1031" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-1032"><a href="#cb24-1032" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-1033"><a href="#cb24-1033" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Top 10 YIMBY-Oriented States"</span>,</span>
<span id="cb24-1034"><a href="#cb24-1034" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Average Composite Score = (-ΔRent Burden) + Housing Growth + Population Growth"</span>,</span>
<span id="cb24-1035"><a href="#cb24-1035" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"State"</span>,</span>
<span id="cb24-1036"><a href="#cb24-1036" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average YIMBY Composite Score (standardized)"</span></span>
<span id="cb24-1037"><a href="#cb24-1037" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-1038"><a href="#cb24-1038" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>) <span class="sc">+</span></span>
<span id="cb24-1039"><a href="#cb24-1039" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb24-1040"><a href="#cb24-1040" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb24-1041"><a href="#cb24-1041" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb24-1042"><a href="#cb24-1042" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb24-1043"><a href="#cb24-1043" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-1044"><a href="#cb24-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1045"><a href="#cb24-1045" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1046"><a href="#cb24-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1047"><a href="#cb24-1047" aria-hidden="true" tabindex="-1"></a><span class="fu"># Task 7: Policy Brief</span></span>
<span id="cb24-1048"><a href="#cb24-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1049"><a href="#cb24-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1050"><a href="#cb24-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1051"><a href="#cb24-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1052"><a href="#cb24-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1053"><a href="#cb24-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1054"><a href="#cb24-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1055"><a href="#cb24-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1056"><a href="#cb24-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1057"><a href="#cb24-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1058"><a href="#cb24-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1059"><a href="#cb24-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1060"><a href="#cb24-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1061"><a href="#cb24-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1062"><a href="#cb24-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1063"><a href="#cb24-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1064"><a href="#cb24-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1065"><a href="#cb24-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1066"><a href="#cb24-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1067"><a href="#cb24-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1068"><a href="#cb24-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1069"><a href="#cb24-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1070"><a href="#cb24-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1071"><a href="#cb24-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1072"><a href="#cb24-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1073"><a href="#cb24-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1074"><a href="#cb24-1074" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>